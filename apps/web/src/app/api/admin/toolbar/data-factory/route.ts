import { z } from 'zod';
import {
  withAdminAuthAndErrors,
  getUserId,
  getCampusId,
  type AuthenticatedRequest,
} from '@/lib/middleware';
import { dbAdmin } from '@/lib/firebase-admin';
import { logAdminActivity } from '@/lib/admin-activity';

const CreateTestDataSchema = z.object({
  type: z.literal('space'),
  config: z.object({
    name: z.string().min(1).max(100),
    memberCount: z.number().int().min(0).max(20).optional().default(0),
    postCount: z.number().int().min(0).max(50).optional().default(0),
  }),
});

/**
 * POST /api/admin/toolbar/data-factory
 * Create test data (spaces, members, posts)
 */
export const POST = withAdminAuthAndErrors(async (request, context, respond) => {
  const req = request as AuthenticatedRequest;
  const adminId = getUserId(req);
  const campusId = getCampusId(req);

  const body = CreateTestDataSchema.parse(await request.json());
  const { type, config } = body;

  if (type === 'space') {
    const batchId = crypto.randomUUID();
    const handle = config.name.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-|-$/g, '') + '-test-' + batchId.slice(0, 6);

    // Create the space document
    const spaceRef = await dbAdmin.collection('spaces').add({
      name: config.name,
      handle,
      description: `Test space created by admin toolbar`,
      campusId,
      createdBy: adminId,
      createdAt: new Date(),
      updatedAt: new Date(),
      memberCount: 1 + config.memberCount,
      visibility: 'public',
      status: 'active',
      _test: true,
      _testCreatedBy: adminId,
      _testBatchId: batchId,
    });

    // Add the admin as owner member
    await dbAdmin.collection('spaces').doc(spaceRef.id).collection('members').doc(adminId).set({
      userId: adminId,
      role: 'owner',
      joinedAt: new Date(),
      campusId,
      _test: true,
      _testCreatedBy: adminId,
      _testBatchId: batchId,
    });

    // Create test posts if requested
    if (config.postCount > 0) {
      const batch = dbAdmin.batch();
      for (let i = 0; i < config.postCount; i++) {
        const postRef = dbAdmin.collection('spaces').doc(spaceRef.id).collection('posts').doc();
        batch.set(postRef, {
          content: `Test post #${i + 1} â€” generated by admin toolbar`,
          authorId: adminId,
          spaceId: spaceRef.id,
          createdAt: new Date(Date.now() - (config.postCount - i) * 60000),
          updatedAt: new Date(),
          campusId,
          _test: true,
          _testCreatedBy: adminId,
          _testBatchId: batchId,
        });
      }
      await batch.commit();
    }

    await logAdminActivity({
      adminId,
      action: 'create_test_data',
      targetType: 'space',
      targetId: spaceRef.id,
      details: { batchId, config, handle },
    });

    return respond.success({
      id: spaceRef.id,
      handle,
      url: `/s/${handle}`,
      batchId,
    });
  }

  return respond.error('Unsupported test data type', 'VALIDATION_ERROR');
});

/**
 * DELETE /api/admin/toolbar/data-factory
 * Clean up all test data created by the current admin
 */
export const DELETE = withAdminAuthAndErrors(async (request, context, respond) => {
  const req = request as AuthenticatedRequest;
  const adminId = getUserId(req);

  // Find all test spaces created by this admin
  const testSpaces = await dbAdmin
    .collection('spaces')
    .where('_test', '==', true)
    .where('_testCreatedBy', '==', adminId)
    .get();

  let deletedSpaces = 0;
  let deletedPosts = 0;

  for (const spaceDoc of testSpaces.docs) {
    // Delete posts subcollection
    const posts = await spaceDoc.ref.collection('posts').get();
    const postBatch = dbAdmin.batch();
    posts.docs.forEach(doc => postBatch.delete(doc.ref));
    if (posts.docs.length > 0) {
      await postBatch.commit();
      deletedPosts += posts.docs.length;
    }

    // Delete members subcollection
    const members = await spaceDoc.ref.collection('members').get();
    const memberBatch = dbAdmin.batch();
    members.docs.forEach(doc => memberBatch.delete(doc.ref));
    if (members.docs.length > 0) await memberBatch.commit();

    // Delete the space itself
    await spaceDoc.ref.delete();
    deletedSpaces++;
  }

  await logAdminActivity({
    adminId,
    action: 'cleanup_test_data',
    targetType: 'space',
    targetId: 'bulk',
    details: { deletedSpaces, deletedPosts },
  });

  return respond.success({
    deleted: { spaces: deletedSpaces, posts: deletedPosts },
  });
});
