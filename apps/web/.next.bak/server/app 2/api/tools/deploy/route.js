"use strict";(()=>{var a={};a.id=6979,a.ids=[6979],a.modules={261:a=>{a.exports=require("next/dist/shared/lib/router/utils/app-paths")},3295:a=>{a.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},4573:a=>{a.exports=require("node:buffer")},5872:(a,b,c)=>{c.d(b,{b0:()=>d.b0,eB:()=>d.eB,hE:()=>d.hE,j1:()=>d.j1,w6:()=>d.w6});var d=c(86920)},10846:a=>{a.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},12485:(a,b,c)=>{c.a(a,async(a,d)=>{try{c.r(b),c.d(b,{handler:()=>x,patchFetch:()=>w,routeModule:()=>y,serverHooks:()=>B,workAsyncStorage:()=>z,workUnitAsyncStorage:()=>A});var e=c(98128),f=c(48869),g=c(78868),h=c(37526),i=c(21884),j=c(261),k=c(24218),l=c(73640),m=c(66376),n=c(36363),o=c(73605),p=c(76583),q=c(19465),r=c(78910),s=c(86439),t=c(48724),u=c(52562),v=a([u]);u=(v.then?(await v)():v)[0];let y=new e.AppRouteRouteModule({definition:{kind:f.RouteKind.APP_ROUTE,page:"/api/tools/deploy/route",pathname:"/api/tools/deploy",filename:"route",bundlePath:"app/api/tools/deploy/route"},distDir:".next",relativeProjectDir:"",resolvedPagePath:"/Users/laneyfraass/Desktop/HIVE/apps/web/src/app/api/tools/deploy/route.ts",nextConfigOutput:"",userland:u}),{workAsyncStorage:z,workUnitAsyncStorage:A,serverHooks:B}=y;function w(){return(0,g.patchFetch)({workAsyncStorage:z,workUnitAsyncStorage:A})}async function x(a,b,c){var d;let e="/api/tools/deploy/route";"/index"===e&&(e="/");let g=await y.prepare(a,b,{srcPage:e,multiZoneDraftMode:!1});if(!g)return b.statusCode=400,b.end("Bad Request"),null==c.waitUntil||c.waitUntil.call(c,Promise.resolve()),null;let{buildId:u,params:v,nextConfig:w,isDraftMode:x,prerenderManifest:z,routerServerContext:A,isOnDemandRevalidate:B,revalidateOnlyGenerated:C,resolvedPathname:D}=g,E=(0,j.normalizeAppPath)(e),F=!!(z.dynamicRoutes[E]||z.routes[D]);if(F&&!x){let a=!!z.routes[D],b=z.dynamicRoutes[E];if(b&&!1===b.fallback&&!a)throw new s.NoFallbackError}let G=null;!F||y.isDev||x||(G=D,G="/index"===G?"/":G);let H=!0===y.isDev||!F,I=F&&!H,J=a.method||"GET",K=(0,i.getTracer)(),L=K.getActiveScopeSpan(),M={params:v,prerenderManifest:z,renderOpts:{experimental:{cacheComponents:!!w.experimental.cacheComponents,authInterrupts:!!w.experimental.authInterrupts},supportsDynamicResponse:H,incrementalCache:(0,h.getRequestMeta)(a,"incrementalCache"),cacheLifeProfiles:null==(d=w.experimental)?void 0:d.cacheLife,isRevalidate:I,waitUntil:c.waitUntil,onClose:a=>{b.on("close",a)},onAfterTaskError:void 0,onInstrumentationRequestError:(b,c,d)=>y.onRequestError(a,b,d,A)},sharedContext:{buildId:u}},N=new k.NodeNextRequest(a),O=new k.NodeNextResponse(b),P=l.NextRequestAdapter.fromNodeNextRequest(N,(0,l.signalFromNodeResponse)(b));try{let d=async c=>y.handle(P,M).finally(()=>{if(!c)return;c.setAttributes({"http.status_code":b.statusCode,"next.rsc":!1});let d=K.getRootSpanAttributes();if(!d)return;if(d.get("next.span_type")!==m.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${d.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let e=d.get("next.route");if(e){let a=`${J} ${e}`;c.setAttributes({"next.route":e,"http.route":e,"next.span_name":a}),c.updateName(a)}else c.updateName(`${J} ${a.url}`)}),g=async g=>{var i,j;let k=async({previousCacheEntry:f})=>{try{if(!(0,h.getRequestMeta)(a,"minimalMode")&&B&&C&&!f)return b.statusCode=404,b.setHeader("x-nextjs-cache","REVALIDATED"),b.end("This page could not be found"),null;let e=await d(g);a.fetchMetrics=M.renderOpts.fetchMetrics;let i=M.renderOpts.pendingWaitUntil;i&&c.waitUntil&&(c.waitUntil(i),i=void 0);let j=M.renderOpts.collectedTags;if(!F)return await (0,o.I)(N,O,e,M.renderOpts.pendingWaitUntil),null;{let a=await e.blob(),b=(0,p.toNodeOutgoingHttpHeaders)(e.headers);j&&(b[r.NEXT_CACHE_TAGS_HEADER]=j),!b["content-type"]&&a.type&&(b["content-type"]=a.type);let c=void 0!==M.renderOpts.collectedRevalidate&&!(M.renderOpts.collectedRevalidate>=r.INFINITE_CACHE)&&M.renderOpts.collectedRevalidate,d=void 0===M.renderOpts.collectedExpire||M.renderOpts.collectedExpire>=r.INFINITE_CACHE?void 0:M.renderOpts.collectedExpire;return{value:{kind:t.CachedRouteKind.APP_ROUTE,status:e.status,body:Buffer.from(await a.arrayBuffer()),headers:b},cacheControl:{revalidate:c,expire:d}}}}catch(b){throw(null==f?void 0:f.isStale)&&await y.onRequestError(a,b,{routerKind:"App Router",routePath:e,routeType:"route",revalidateReason:(0,n.c)({isRevalidate:I,isOnDemandRevalidate:B})},A),b}},l=await y.handleResponse({req:a,nextConfig:w,cacheKey:G,routeKind:f.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:z,isRoutePPREnabled:!1,isOnDemandRevalidate:B,revalidateOnlyGenerated:C,responseGenerator:k,waitUntil:c.waitUntil});if(!F)return null;if((null==l||null==(i=l.value)?void 0:i.kind)!==t.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==l||null==(j=l.value)?void 0:j.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});(0,h.getRequestMeta)(a,"minimalMode")||b.setHeader("x-nextjs-cache",B?"REVALIDATED":l.isMiss?"MISS":l.isStale?"STALE":"HIT"),x&&b.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let m=(0,p.fromNodeOutgoingHttpHeaders)(l.value.headers);return(0,h.getRequestMeta)(a,"minimalMode")&&F||m.delete(r.NEXT_CACHE_TAGS_HEADER),!l.cacheControl||b.getHeader("Cache-Control")||m.get("Cache-Control")||m.set("Cache-Control",(0,q.getCacheControlHeader)(l.cacheControl)),await (0,o.I)(N,O,new Response(l.value.body,{headers:m,status:l.value.status||200})),null};L?await g(L):await K.withPropagatedContext(a.headers,()=>K.trace(m.BaseServerSpan.handleRequest,{spanName:`${J} ${a.url}`,kind:i.SpanKind.SERVER,attributes:{"http.method":J,"http.target":a.url}},g))}catch(b){if(b instanceof s.NoFallbackError||await y.onRequestError(a,b,{routerKind:"App Router",routePath:E,routeType:"route",revalidateReason:(0,n.c)({isRevalidate:I,isOnDemandRevalidate:B})}),F)throw b;return await (0,o.I)(N,O,new Response(null,{status:500})),null}}d()}catch(a){d(a)}})},14276:a=>{a.exports=import("firebase-admin/auth")},19121:a=>{a.exports=require("next/dist/server/app-render/action-async-storage.external.js")},24452:(a,b,c)=>{c.a(a,async(a,d)=>{try{c.r(b),c.d(b,{"7f08e221c8a0f0dfdd3f5e3e580738f3da3c689217":()=>e.GET,"7ff5e01e11301fe3bc766f6693c533e8c6fdbc1eef":()=>e.POST});var e=c(52562),f=a([e]);e=(f.then?(await f)():f)[0],d()}catch(a){d(a)}})},28354:a=>{a.exports=require("util")},29294:a=>{a.exports=require("next/dist/server/app-render/work-async-storage.external.js")},44870:a=>{a.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},46675:a=>{a.exports=require("firebase-admin")},52562:(a,b,c)=>{c.a(a,async(a,d)=>{try{c.r(b),c.d(b,{GET:()=>G,POST:()=>F});var e=c(74447);c(73249);var f=c(54760),g=c(38929),h=c(46675),i=c(91714),j=c(25384),k=c(94205),l=c(67822),m=c(59655),n=c(5872),o=c(81517),p=a([k]);k=(p.then?(await p)():p)[0];let w=f.k5(["pinned","posts","events","tools","chat","members"]),x=f.Ik({canInteract:f.zM().optional(),canView:f.zM().optional(),canEdit:f.zM().optional(),allowedRoles:f.YO(f.Yj()).optional()}).optional(),y=f.Ik({showInDirectory:f.zM().optional(),allowSharing:f.zM().optional(),collectAnalytics:f.zM().optional(),notifyOnInteraction:f.zM().optional()}).optional(),z=f.Ik({read_space_context:f.zM().optional(),read_space_members:f.zM().optional(),write_shared_state:f.zM().optional(),create_posts:f.zM().optional(),send_notifications:f.zM().optional(),trigger_automations:f.zM().optional(),objects_read:f.KC([f.zM(),f.YO(f.Yj())]).optional(),objects_write:f.KC([f.zM(),f.YO(f.Yj())]).optional(),objects_delete:f.KC([f.zM(),f.YO(f.Yj())]).optional()}).optional(),A=f.Ik({widget:f.zM(),app:f.zM()}).optional(),B=f.Ik({layout:f.k5(["full","centered","sidebar"]).optional(),showWidgetWhenActive:f.zM().optional(),breadcrumbLabel:f.Yj().max(50).optional()}).optional(),C=f.Ik({notificationsPerDay:f.ai().min(0).max(100).optional(),postsPerDay:f.ai().min(0).max(100).optional(),automationsPerDay:f.ai().min(0).max(500).optional(),executionsPerUserPerHour:f.ai().min(0).max(1e3).optional()}).optional(),D=f.Ik({toolId:f.Yj(),deployTo:f.k5(["profile","space"]),targetId:f.Yj(),surface:w.optional(),config:f.g1(f.bz()).optional(),permissions:x,settings:y,capabilities:z,budgets:C,experimental:f.zM().optional(),surfaceModes:A,primarySurface:f.k5(["widget","app"]).optional(),appConfig:B}),E=["member-list","member-selector","space-events","space-feed","space-stats","announcement","role-gate"];async function q(a,b){let c=await g.dbAdmin.collection("tools").doc(a).get();if(!c.exists)return{ok:!1,status:404,message:"Tool not found"};let d=c.data();return d?d.campusId&&d.campusId!==j.e3?{ok:!1,status:403,message:"Access denied for this campus"}:d.ownerId!==b&&"published"!==d.status?{ok:!1,status:403,message:"Tool not available for deployment"}:{ok:!0,toolDoc:c,toolData:d}:{ok:!1,status:404,message:"Tool data missing"}}async function r(a,b){let c=await g.dbAdmin.collection("spaces").doc(a).get();if(!c.exists)return{ok:!1,status:404,message:"Space not found"};let d=c.data();if(d?.campusId&&d.campusId!==j.e3)return{ok:!1,status:403,message:"Access denied for this campus"};let e=d?.members?.[b]?.role;return e&&["builder","admin","moderator"].includes(e)?{ok:!0,spaceData:d}:{ok:!1,status:403,message:"Insufficient permissions to deploy tools"}}async function s(a){return(await g.dbAdmin.collection("deployedTools").where("toolId","==",a.toolId).where("deployedTo","==",a.deployTo).where("targetId","==",a.targetId).where("campusId","==",j.e3).where("status","in",["active","paused"]).limit(1).get()).empty}async function t(a){return(await g.dbAdmin.collection("deployedTools").where("deployedTo","==","space").where("targetId","==",a).where("campusId","==",j.e3).where("status","==","active").get()).size>=20?{ok:!1,status:409,message:"Space has reached maximum tool limit (20)"}:{ok:!0}}async function u(a,b,c){try{let d=g.dbAdmin.collection("deployedTools").where("deployedTo","==",a).where("targetId","==",b).where("campusId","==",j.e3).where("status","==","active");return c&&(d=d.where("surface","==",c)),(await d.get()).size}catch(a){return i.vF.error("Error determining deployment order",{error:a instanceof Error?a.message:String(a)}),0}}async function v(a,b){if(b.campusId&&b.campusId!==j.e3)return!1;if("profile"===b.deployedTo&&b.targetId===a||b.deployedBy===a)return!0;if("space"===b.deployedTo){let c=await g.dbAdmin.collection("spaces").doc(b.targetId).get();if(!c.exists)return!1;let d=c.data();if(d?.campusId&&d.campusId!==j.e3)return!1;let e=d?.members?.[a]?.role;return b.permissions?.allowedRoles?.includes(e)??!1}return!1}let F=(0,k.SH)(D,async(a,b,c,d)=>{let e=(0,k.F6)(a);i.vF.info("Deploying tool",{toolId:c.toolId,deployTo:c.deployTo,targetId:c.targetId,userUid:e});let f=await q(c.toolId,e);if(!f.ok)return d.error(f.message,"FORBIDDEN",{status:f.status});if(function(a){return(a.composition?.elements||a.elements||[]).some(a=>E.includes(a.elementId||""))}(f.toolData)&&"profile"===c.deployTo)return d.error("This tool contains space-tier elements and can only be deployed to spaces","FORBIDDEN",{status:403});if("profile"===c.deployTo&&c.targetId!==e)return d.error("Can only deploy tools to your own profile","FORBIDDEN",{status:403});if("space"===c.deployTo){let a=await r(c.targetId,e);if(!a.ok)return d.error(a.message,"FORBIDDEN",{status:a.status});if(c.surface&&!w.options.includes(c.surface))return d.error("Invalid surface","INVALID_INPUT",{status:400});let b=await t(c.targetId);if(!b.ok)return d.error(b.message,"CONFLICT",{status:b.status})}if(!await s(c))return d.error("Tool already deployed to this target","CONFLICT",{status:409});let o=function(a,b){if(!a)return{ok:!0};let c=b??{widget:!0,app:!1};return a.app&&!c.app?{ok:!1,error:"This tool does not support app surface"}:a.widget&&!c.widget?{ok:!1,error:"This tool does not support widget surface"}:a.widget||a.app?{ok:!0}:{ok:!1,error:"At least one surface mode must be enabled"}}(c.surfaceModes,f.toolData.supportedSurfaces);if(!o.ok)return d.error(o.error,"INVALID_INPUT",{status:400});let p=f.toolData.provenance?.trustTier||"unverified",v=(0,n.eB)(c.capabilities||{},p);if(!v.valid)return d.error(`Capability validation failed: ${v.errors.join(", ")}`,"FORBIDDEN",{status:403});let x=new Date,y=c.surface??("space"===c.deployTo?"tools":void 0),z=function(a){return{canInteract:a?.canInteract??!0,canView:a?.canView??!0,canEdit:a?.canEdit??!1,allowedRoles:a?.allowedRoles??["member","moderator","admin","builder"]}}(c.permissions),A=function(a){return{showInDirectory:a?.showInDirectory??!0,allowSharing:a?.allowSharing??!0,collectAnalytics:a?.collectAnalytics??!0,notifyOnInteraction:a?.notifyOnInteraction??!1}}(c.settings),B=function(a){return{read_own_state:!0,write_own_state:!0,read_space_context:a?.read_space_context??!1,read_space_members:a?.read_space_members??!1,write_shared_state:a?.write_shared_state??!0,create_posts:a?.create_posts??!1,send_notifications:a?.send_notifications??!1,trigger_automations:a?.trigger_automations??!1,objects_read:a?.objects_read??!1,objects_write:a?.objects_write??!1,objects_delete:a?.objects_delete??!1}}(c.capabilities),C=(0,n.b0)(B),D=function(a,b){let c=(0,n.w6)(b);return{notificationsPerDay:a?.notificationsPerDay??c.notificationsPerDay,postsPerDay:a?.postsPerDay??c.postsPerDay,automationsPerDay:a?.automationsPerDay??c.automationsPerDay,executionsPerUserPerHour:a?.executionsPerUserPerHour??c.executionsPerUserPerHour}}(c.budgets,B),F=c.experimental??!1,G=function(a,b){let c=a??n.j1,d=b??{widget:!0,app:!1};return{widget:c.widget&&(d.widget??!0),app:c.app&&(d.app??!1)}}(c.surfaceModes,f.toolData.supportedSurfaces),H=c.primarySurface??(G.app&&!G.widget?"app":"widget"),I=G.app?function(a,b){return{layout:a?.layout??b?.layout??n.hE.layout,showWidgetWhenActive:a?.showWidgetWhenActive??b?.showWidgetWhenActive??n.hE.showWidgetWhenActive,breadcrumbLabel:a?.breadcrumbLabel}}(c.appConfig,f.toolData.appDefaults):void 0,J=f.toolData.currentVersion||"1.0.0",K=function(a,b,c){let d=a.provenance||{};return{creatorId:d.creatorId||a.ownerId||b,forkedFrom:d.forkedFrom,lineage:d.lineage||[],createdAt:c.toISOString(),trustTier:d.trustTier||"unverified"}}(f.toolData,e,x),L=await u(c.deployTo,c.targetId,y),M="space"===c.deployTo?"space":"profile",N=`deployment_${Date.now()}`,O=(0,l.eS)(N,c.toolId),P=(0,l.eS)(M,c.targetId),Q="space"===M?g.dbAdmin.collection("spaces").doc(c.targetId).collection("placed_tools").doc(O):g.dbAdmin.collection("users").doc(c.targetId).collection("placed_tools").doc(O),R="space"===M?`spaces/${c.targetId}/placed_tools/${O}`:`users/${c.targetId}/placed_tools/${O}`,S={id:P,toolId:c.toolId,deployedBy:e,deployedTo:c.deployTo,targetType:M,targetId:c.targetId,surface:y,position:L,config:c.config??{},permissions:z,status:"active",deployedAt:x.toISOString(),usageCount:0,settings:A,metadata:{toolName:f.toolData.name,toolVersion:f.toolData.currentVersion},placementId:O,placementPath:R,creatorId:e,spaceId:"space"===M?c.targetId:null,profileId:"profile"===M?c.targetId:null,campusId:j.e3,capabilities:B,budgets:D,capabilityLane:C,experimental:F,surfaceModes:G,primarySurface:H,appConfig:I,toolVersion:J,provenance:K};if(await g.dbAdmin.runTransaction(async a=>{a.set(Q,{toolId:c.toolId,placement:"sidebar",order:L,isActive:!0,source:"leader",placedBy:e,placedAt:h.firestore.FieldValue.serverTimestamp(),configOverrides:c.config??{},visibility:"all",titleOverride:null,isEditable:!0,state:{},stateUpdatedAt:null,campusId:j.e3,deploymentId:N,createdAt:h.firestore.FieldValue.serverTimestamp(),updatedAt:h.firestore.FieldValue.serverTimestamp()});let b=g.dbAdmin.collection("deployedTools").doc(P);a.set(b,S);let d=g.dbAdmin.collection("tools").doc(c.toolId);a.update(d,{deploymentCount:h.firestore.FieldValue.increment(1),lastDeployedAt:x.toISOString()})}),await g.dbAdmin.collection("analytics_events").add({eventType:"tool_deployed",userId:e,toolId:c.toolId,campusId:j.e3,spaceId:"space"===c.deployTo?c.targetId:null,timestamp:x.toISOString(),metadata:{deploymentId:P,deployedTo:c.deployTo,surface:y??null}}),"space"===c.deployTo)try{let a=await g.dbAdmin.collection("users").doc(e).get(),b=a.data()?.fullName||"Someone",d=(await g.dbAdmin.collection("spaces").doc(c.targetId).get()).data(),h=d?.name||"a space",i=(await g.dbAdmin.collection("spaceMembers").where("spaceId","==",c.targetId).where("campusId","==",j.e3).where("isActive","==",!0).get()).docs.map(a=>a.data().userId);i.length>0&&await (0,m.HP)({memberIds:i,deployerId:e,deployerName:b,toolId:c.toolId,toolName:f.toolData.name,spaceId:c.targetId,spaceName:h})}catch(a){i.vF.warn("Failed to send tool deployment notifications",{error:a instanceof Error?a.message:String(a),toolId:c.toolId,spaceId:c.targetId})}return d.created({deployment:S,message:"Tool deployed successfully"},{message:"Tool deployed successfully"})}),G=(0,k.lT)(async(a,b,c)=>{try{let b=(0,k.F6)(a),d=new URL(a.url).searchParams,e=d.get("deployedTo"),f=d.get("targetId"),h=d.get("surface"),i=d.get("status")??"active",l=g.dbAdmin.collection("deployedTools").where("campusId","==",j.e3);e&&(l=l.where("deployedTo","==",e)),f&&(l=l.where("targetId","==",f)),h&&(l=l.where("surface","==",h)),l=l.where("status","==",i);let m=await l.get(),n=[];for(let a of m.docs){let c=a.data();if(!await v(b,c))continue;let d=c.toolId;if(!d)continue;let e=await g.dbAdmin.collection("tools").doc(d).get();if(!e.exists)continue;let f=e.data();f?.campusId&&f.campusId!==j.e3||n.push({id:a.id,...c,toolData:{id:e.id,name:f?.name,description:f?.description,currentVersion:f?.currentVersion,elements:f?.elements}})}return c.success({deployments:n,count:n.length})}catch(a){return i.vF.error("Error fetching deployed tools",{error:a instanceof Error?a.message:String(a)}),c.error("Failed to fetch deployed tools","INTERNAL_ERROR",{status:500})}});(0,o.D)([F,G]),(0,e.A)(F,"7ff5e01e11301fe3bc766f6693c533e8c6fdbc1eef",null),(0,e.A)(G,"7f08e221c8a0f0dfdd3f5e3e580738f3da3c689217",null),d()}catch(a){d(a)}})},55511:a=>{a.exports=require("crypto")},57975:a=>{a.exports=require("node:util")},59655:(a,b,c)=>{c.d(b,{Fu:()=>n,HP:()=>o,Jp:()=>j,Ol:()=>k,Ur:()=>l,vT:()=>m});var d=c(38929),e=c(97338),f=c(25384);let g={enabled:!0,categories:{social:!0,spaces:!0,events:!0,connections:!0,tools:!0,system:!0}};async function h(a){try{let b=await d.dbAdmin.collection("users").doc(a).get();if(!b.exists)return g;let c=b.data();return c?.notificationPreferences||g}catch(b){return e.v.error("Error getting notification preferences",{error:b instanceof Error?b.message:String(b),userId:a}),g}}async function i(a){let{userId:b,type:c,category:g,title:i,body:j,actionUrl:k,metadata:l}=a;try{if(l?.actorId===b)return null;let a=await h(b);if(!function(a,b){if(!a.enabled||!a.categories[b])return!1;if(void 0!==a.quietHoursStart&&void 0!==a.quietHoursEnd){let b=new Date().getHours();if(a.quietHoursStart<a.quietHoursEnd){if(b>=a.quietHoursStart&&b<a.quietHoursEnd)return!1}else if(b>=a.quietHoursStart||b<a.quietHoursEnd)return!1}return!0}(a,g))return e.v.debug("Notification blocked by preferences",{userId:b,type:c,category:g}),null;let m=new Date(Date.now()-36e5).toISOString();if(!(await d.dbAdmin.collection("notifications").where("userId","==",b).where("type","==",c).where("metadata.actorId","==",l?.actorId||"").where("timestamp",">=",m).limit(1).get()).empty&&"system"!==c)return e.v.debug("Duplicate notification prevented",{userId:b,type:c,actorId:l?.actorId}),null;let n={userId:b,type:c,category:g,title:i,body:j||"",actionUrl:k||"",isRead:!1,timestamp:new Date().toISOString(),campusId:f.e3,metadata:l||{}},o=await d.dbAdmin.collection("notifications").add(n);return e.v.info("Notification created",{notificationId:o.id,userId:b,type:c,category:g}),o.id}catch(a){return e.v.error("Error creating notification",{error:a instanceof Error?a.message:String(a),userId:b,type:c}),null}}async function j(a,b){let c=0;for(let d=0;d<a.length;d+=10){let e=a.slice(d,d+10).map(a=>i({...b,userId:a}));c+=(await Promise.all(e)).filter(Boolean).length}return c}async function k(a){return i({userId:a.leaderUserId,type:"space_join",category:"spaces",title:`${a.newMemberName} joined ${a.spaceName}`,actionUrl:`/spaces/${a.spaceId}/members`,metadata:{actorId:a.newMemberId,actorName:a.newMemberName,spaceId:a.spaceId,spaceName:a.spaceName}})}async function l(a){return i({userId:a.userId,type:"builder_approved",category:"spaces",title:`You're now a leader of ${a.spaceName}!`,body:"Your builder request has been approved",actionUrl:`/spaces/${a.spaceId}`,metadata:{actorId:a.adminId,actorName:a.adminName,spaceId:a.spaceId,spaceName:a.spaceName}})}async function m(a){return i({userId:a.userId,type:"builder_rejected",category:"spaces",title:`Builder request for ${a.spaceName} was not approved`,body:a.reason||"Contact support for more information",actionUrl:`/spaces/${a.spaceId}`,metadata:{actorId:a.adminId,actorName:a.adminName,spaceId:a.spaceId,spaceName:a.spaceName,reason:a.reason}})}async function n(a){return"not_going"===a.rsvpStatus?null:i({userId:a.organizerId,type:"event_rsvp",category:"events",title:`${a.attendeeName} is ${"going"===a.rsvpStatus?"attending":"interested in"} ${a.eventTitle}`,actionUrl:`/spaces/${a.spaceId}/events/${a.eventId}`,metadata:{actorId:a.attendeeId,actorName:a.attendeeName,eventId:a.eventId,eventTitle:a.eventTitle,spaceId:a.spaceId,rsvpStatus:a.rsvpStatus}})}async function o(a){let b={type:"tool_deployed",category:"tools",title:`New tool in ${a.spaceName}: ${a.toolName}`,body:`Deployed by ${a.deployerName}`,actionUrl:`/spaces/${a.spaceId}?tool=${a.toolId}`,metadata:{actorId:a.deployerId,actorName:a.deployerName,toolId:a.toolId,toolName:a.toolName,spaceId:a.spaceId,spaceName:a.spaceName}};return j(a.memberIds.filter(b=>b!==a.deployerId),b)}},63033:a=>{a.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},67822:(a,b,c)=>{c.d(b,{TH:()=>i,Z:()=>h,eS:()=>g});var d=c(38929),e=c(46675),f=c(97338);function g(a,b){return`${a}_${b}`}async function h(a){let b,c,f=g(a.deploymentId,a.toolId);if("space"===a.deployedTo)b=d.dbAdmin.collection("spaces").doc(a.targetId).collection("placed_tools").doc(f),c=`spaces/${a.targetId}/placed_tools/${f}`;else if("profile"===a.deployedTo)b=d.dbAdmin.collection("users").doc(a.targetId).collection("placed_tools").doc(f),c=`users/${a.targetId}/placed_tools/${f}`;else throw Error("Invalid deployment target");return await b.set({toolId:a.toolId,placement:a.placement||"sidebar",order:a.order??0,isActive:!0,source:"leader",placedBy:a.placedBy,placedAt:e.firestore.FieldValue.serverTimestamp(),configOverrides:a.configOverrides||a.settings||{},visibility:a.visibility||"all",titleOverride:a.titleOverride||null,isEditable:!0,state:{},stateUpdatedAt:null,campusId:a.campusId,deploymentId:a.deploymentId,createdAt:e.firestore.FieldValue.serverTimestamp(),updatedAt:e.firestore.FieldValue.serverTimestamp()}),{id:f,path:c,ref:b}}async function i(a){try{let b=a.data();if(!b)return null;if("space"===b.deployedTo&&b.targetId&&b.placementId){let a=d.dbAdmin.collection("spaces").doc(b.targetId).collection("placed_tools").doc(b.placementId),c=await a.get();if(c.exists)return{snapshot:c,ref:a}}if("profile"===b.deployedTo&&b.targetId&&b.placementId){let a=d.dbAdmin.collection("users").doc(b.targetId).collection("placed_tools").doc(b.placementId),c=await a.get();if(c.exists)return{snapshot:c,ref:a}}return null}catch(a){return f.v.error("Error getting placement from deployment",{component:"tool-placement"},a instanceof Error?a:void 0),null}}},73249:(a,b,c)=>{Object.defineProperty(b,"__esModule",{value:!0}),!function(a,b){for(var c in b)Object.defineProperty(a,c,{enumerable:!0,get:b[c]})}(b,{decryptActionBoundArgs:function(){return s},encryptActionBoundArgs:function(){return r}}),c(85037);let d=c(41210),e=c(62521),f=c(86062),g=c(87189),h=c(63033),i=c(10786),j=function(a){return a&&a.__esModule?a:{default:a}}(c(95579)),k=new TextEncoder,l=new TextDecoder,m=void 0,n=void 0;async function o(a,b){let c=await (0,g.getActionEncryptionKey)();if(void 0===c)throw Object.defineProperty(Error("Missing encryption key for Server Action. This is a bug in Next.js"),"__NEXT_ERROR_CODE",{value:"E65",enumerable:!1,configurable:!0});let d=atob(b),e=d.slice(0,16),f=d.slice(16),h=l.decode(await (0,g.decrypt)(c,(0,g.stringToUint8Array)(e),(0,g.stringToUint8Array)(f)));if(!h.startsWith(a))throw Object.defineProperty(Error("Invalid Server Action payload: failed to decrypt."),"__NEXT_ERROR_CODE",{value:"E191",enumerable:!1,configurable:!0});return h.slice(a.length)}async function p(a,b){let c=await (0,g.getActionEncryptionKey)();if(void 0===c)throw Object.defineProperty(Error("Missing encryption key for Server Action. This is a bug in Next.js"),"__NEXT_ERROR_CODE",{value:"E65",enumerable:!1,configurable:!0});let d=new Uint8Array(16);h.workUnitAsyncStorage.exit(()=>crypto.getRandomValues(d));let e=(0,g.arrayBufferToString)(d.buffer),f=await (0,g.encrypt)(c,d,k.encode(a+b));return btoa(e+(0,g.arrayBufferToString)(f))}var q=function(a){return a[a.Ready=0]="Ready",a[a.Pending=1]="Pending",a[a.Complete=2]="Complete",a}(q||{});let r=j.default.cache(async function a(b,...c){let e=h.workUnitAsyncStorage.getStore(),j=e?(0,h.getCacheSignal)(e):void 0,{clientModules:k}=(0,g.getClientReferenceManifestForRsc)(),l=Error();Error.captureStackTrace(l,a);let n=!1,o=e?(0,i.createHangingInputAbortSignal)(e):void 0,q=0;function r(){0===q&&(q=1,null==j||j.beginRead())}function s(){1===q&&(null==j||j.endRead()),q=2}o&&j&&o.addEventListener("abort",r,{once:!0});let t=await (0,f.streamToString)((0,d.renderToReadableStream)(c,k,{filterStackFrame:m,signal:o,onError(a){(null==o||!o.aborted)&&(n||(n=!0,l.message=a instanceof Error?a.message:String(a)))}}),o);if(n)throw s(),l;if(!e)return p(b,t);r();let u=(0,h.getPrerenderResumeDataCache)(e),v=(0,h.getRenderResumeDataCache)(e),w=b+t,x=(null==u?void 0:u.encryptedBoundArgs.get(w))??(null==v?void 0:v.encryptedBoundArgs.get(w));if(x)return x;let y=await p(b,t);return s(),null==u||u.encryptedBoundArgs.set(w,y),y});async function s(a,b){let c,d=await b,f=h.workUnitAsyncStorage.getStore();if(f){let b=(0,h.getCacheSignal)(f),e=(0,h.getPrerenderResumeDataCache)(f),g=(0,h.getRenderResumeDataCache)(f);(c=(null==e?void 0:e.decryptedBoundArgs.get(d))??(null==g?void 0:g.decryptedBoundArgs.get(d)))||(null==b||b.beginRead(),c=await o(a,d),null==b||b.endRead(),null==e||e.decryptedBoundArgs.set(d,c))}else c=await o(a,d);let{edgeRscModuleMapping:i,rscModuleMapping:j}=(0,g.getClientReferenceManifestForRsc)();return await (0,e.createFromReadableStream)(new ReadableStream({start(a){switch(a.enqueue(k.encode(c)),null==f?void 0:f.type){case"prerender":case"prerender-runtime":f.renderSignal.aborted?a.close():f.renderSignal.addEventListener("abort",()=>a.close(),{once:!0});break;case"prerender-client":case"prerender-ppr":case"prerender-legacy":case"request":case"cache":case"private-cache":case"unstable-cache":case void 0:return a.close()}}}),{findSourceMapURL:n,serverConsumerManifest:{moduleLoading:null,moduleMap:j,serverModuleMap:(0,g.getServerModuleMap)()}})}},74447:(a,b,c)=>{Object.defineProperty(b,"A",{enumerable:!0,get:function(){return d.registerServerReference}});let d=c(41210)},77598:a=>{a.exports=require("node:crypto")},81517:(a,b)=>{function c(a){for(let b=0;b<a.length;b++){let c=a[b];if("function"!=typeof c)throw Object.defineProperty(Error(`A "use server" file can only export async functions, found ${typeof c}.
Read more: https://nextjs.org/docs/messages/invalid-use-server-value`),"__NEXT_ERROR_CODE",{value:"E352",enumerable:!1,configurable:!0})}}Object.defineProperty(b,"D",{enumerable:!0,get:function(){return c}})},86439:a=>{a.exports=require("next/dist/shared/lib/no-fallback-error.external")},86920:(a,b,c)=>{c.d(b,{Dm:()=>f,Ik:()=>i,_W:()=>d,b0:()=>e,eB:()=>k,hE:()=>m,j1:()=>l,p0:()=>h,w6:()=>g});let d={SAFE:{read_own_state:!0,write_own_state:!0,read_space_context:!1,read_space_members:!1,write_shared_state:!0,create_posts:!1,send_notifications:!1,trigger_automations:!1,objects_read:!1,objects_write:!1,objects_delete:!1},SCOPED:{read_own_state:!0,write_own_state:!0,read_space_context:!0,read_space_members:!0,write_shared_state:!0,create_posts:!1,send_notifications:!1,trigger_automations:!1,objects_read:!1,objects_write:!1,objects_delete:!1},POWER:{read_own_state:!0,write_own_state:!0,read_space_context:!0,read_space_members:!0,write_shared_state:!0,create_posts:!0,send_notifications:!0,trigger_automations:!0,objects_read:!0,objects_write:!0,objects_delete:!1}};function e(a){return a.create_posts||a.send_notifications||a.trigger_automations?"power":a.read_space_context||a.read_space_members?"scoped":"safe"}let f={safe:{notificationsPerDay:0,postsPerDay:0,automationsPerDay:0,executionsPerUserPerHour:60},scoped:{notificationsPerDay:0,postsPerDay:0,automationsPerDay:0,executionsPerUserPerHour:60},power:{notificationsPerDay:3,postsPerDay:10,automationsPerDay:50,executionsPerUserPerHour:60}};function g(a){return{...f[e(a)]}}function h(a,b){if(!a){let a=d.SAFE[b];return Array.isArray(a)?a.length>0:!!a}let c=a[b];return Array.isArray(c)?c.length>0:!!c}function i(a,b,c){return c.sendingNotification&&(b.notificationsSent??0)>=a.notificationsPerDay?{allowed:!1,reason:`Daily notification limit reached (${a.notificationsPerDay}/day)`}:c.creatingPost&&(b.postsCreated??0)>=a.postsPerDay?{allowed:!1,reason:`Daily post limit reached (${a.postsPerDay}/day)`}:c.triggeringAutomation&&(b.automationsTriggered??0)>=a.automationsPerDay?{allowed:!1,reason:`Daily automation limit reached (${a.automationsPerDay}/day)`}:c.userId&&(b.userExecutions?.[c.userId]??0)>=a.executionsPerUserPerHour?{allowed:!1,reason:`Hourly execution limit reached (${a.executionsPerUserPerHour}/hour)`}:{allowed:!0}}let j=/^[a-z0-9_-]+\.[a-z][a-z0-9_]{2,39}$/;function k(a,b){let c=[],d=["verified","system"];!0!==a.objects_read||d.includes(b)||c.push("Wildcard object read access requires verified trust tier"),!0!==a.objects_write||d.includes(b)||c.push("Wildcard object write access requires verified trust tier"),!0!==a.objects_delete||d.includes(b)||c.push("Wildcard object delete access requires verified trust tier");let e=(a,b)=>{if(Array.isArray(a))for(let d of a)j.test(d)||c.push(`Invalid object type ID in ${b}: ${d}`)};return e(a.objects_read,"objects_read"),e(a.objects_write,"objects_write"),e(a.objects_delete,"objects_delete"),{valid:0===c.length,errors:c}}let l={widget:!0,app:!1},m={layout:"full",showWidgetWhenActive:!1}}};var b=require("../../../../webpack-runtime.js");b.C(a);var c=b.X(0,[7545,1684,5524,2845,4760,6402,3272,2269,4205,5384],()=>b(b.s=12485));module.exports=c})();