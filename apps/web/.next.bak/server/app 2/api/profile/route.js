"use strict";(()=>{var a={};a.id=7073,a.ids=[7073],a.modules={261:a=>{a.exports=require("next/dist/shared/lib/router/utils/app-paths")},3295:a=>{a.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},4573:a=>{a.exports=require("node:buffer")},7879:a=>{a.exports=import("firebase-admin/firestore")},10846:a=>{a.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},14276:a=>{a.exports=import("firebase-admin/auth")},19121:a=>{a.exports=require("next/dist/server/app-render/action-async-storage.external.js")},27810:(a,b,c)=>{c.d(b,{Ac:()=>l,Bf:()=>k,Qw:()=>j,ZD:()=>n,mB:()=>m,ng:()=>o});var d=c(38929),e=c(35263),f=c(97338);async function g(a,b={}){let c,{maxRetries:d=3,baseDelayMs:e=100,maxDelayMs:h=2e3,operationName:i="operation"}=b;for(let b=0;b<=d;b++)try{return await a()}catch(k){if(c=k instanceof Error?k:Error(String(k)),b===d||!(c.message.includes("DEADLINE_EXCEEDED")||c.message.includes("UNAVAILABLE")||c.message.includes("RESOURCE_EXHAUSTED")||c.message.includes("INTERNAL")||c.message.includes("ECONNRESET")||c.message.includes("timeout")))break;let a=e*Math.pow(2,b),g=.3*Math.random()*a,j=Math.min(a+g,h);f.v.debug(`Retrying ${i} after ${Math.round(j)}ms (attempt ${b+1}/${d})`,{component:"handle-service",error:c.message}),await new Promise(a=>setTimeout(a,j))}throw c}let h="development"===e.hf,i=new Set(["admin","administrator","root","system","api","www","mail","email","support","help","info","contact","about","terms","privacy","legal","security","safety","abuse","spam","test","testing","dev","development","staging","prod","production","demo","example","sample","null","undefined","true","false","none","empty","blank","default","config","settings","profile","account","user","users","public","private","internal","external","guest","anonymous","unknown","temp","temporary","delete","remove","banned","blocked","suspended","hive","hivecampus","campus"]);function j(a){if(!a||"string"!=typeof a)return{isAvailable:!1,error:"Handle is required"};let b=a.toLowerCase().trim();return b.length<3?{isAvailable:!1,error:"Handle must be at least 3 characters long"}:b.length>20?{isAvailable:!1,error:"Handle must be at most 20 characters long"}:/^[a-zA-Z0-9._-]+$/.test(b)?b.startsWith("_")||b.endsWith("_")?{isAvailable:!1,error:"Handle cannot start or end with underscore"}:b.startsWith(".")||b.endsWith(".")?{isAvailable:!1,error:"Handle cannot start or end with period"}:b.startsWith("-")||b.endsWith("-")?{isAvailable:!1,error:"Handle cannot start or end with hyphen"}:/__+/.test(b)||/\.\.+/.test(b)||/--+/.test(b)?{isAvailable:!1,error:"Handle cannot contain consecutive special characters"}:i.has(b)?{isAvailable:!1,error:"This handle is reserved and cannot be used"}:{isAvailable:!0,normalizedHandle:b}:{isAvailable:!1,error:"Handle can only contain letters, numbers, periods, underscores, and hyphens"}}async function k(a,b){let c=j(b);if(!c.isAvailable)return c;let e=c.normalizedHandle;try{let[b,c]=await Promise.all([a.get(d.dbAdmin.collection("users").where("handle","==",e).limit(1)),a.get(d.dbAdmin.collection("handles").doc(e))]);if(!b.empty||c.exists)return{isAvailable:!1,error:"This handle is already taken",normalizedHandle:e};return{isAvailable:!0,normalizedHandle:e}}catch(a){return f.v.error("Error checking handle availability",{component:"handle-service"},a instanceof Error?a:void 0),{isAvailable:!1,error:"Unable to verify handle availability. Please try again."}}}function l(a,b,c,e){let f=new Date;a.set(d.dbAdmin.collection("handles").doc(b),{userId:c,userEmail:e,reservedAt:f,handle:b})}async function m(a){let b=j(a);if(!b.isAvailable)return b;let c=b.normalizedHandle;if(h||!d.Gg)return f.v.debug("Development mode: Skipping Firestore handle check",{component:"handle-service",handle:c}),{isAvailable:!0,normalizedHandle:c};try{let a=await g(async()=>{let[a,b]=await Promise.all([d.dbAdmin.collection("users").where("handle","==",c).limit(1).get(),d.dbAdmin.collection("handles").doc(c).get()]);return{userQuery:a,handleDoc:b}},{operationName:"checkHandleAvailability",maxRetries:3});if(!a.userQuery.empty||a.handleDoc.exists)return{isAvailable:!1,error:"This handle is already taken",normalizedHandle:c};return{isAvailable:!0,normalizedHandle:c}}catch(a){if(f.v.error("Error checking handle availability",{component:"handle-service"},a instanceof Error?a:void 0),h)return f.v.debug("Development mode: Allowing handle due to Firebase unavailability",{component:"handle-service"}),{isAvailable:!0,normalizedHandle:c};return{isAvailable:!1,error:"Unable to verify handle availability. Please try again."}}}async function n(a,b){let c=j(b);if(!c.isAvailable)return{success:!1,error:c.error};let e=c.normalizedHandle;if(h||!d.Gg)return f.v.debug("Development mode: Skipping handle change transaction",{component:"handle-service"}),{success:!0};try{return await d.dbAdmin.runTransaction(async b=>{let c=d.dbAdmin.collection("users").doc(a),f=await b.get(c);if(!f.exists)return{success:!1,error:"User not found"};let g=f.data(),h=g.handle;if(h===e)return{success:!0};let i=g.handleChangeCount||0,j=g.lastHandleChange;if(i>0&&j){let a=(j.toMillis?j.toMillis():new Date(j).getTime())+15552e6;if(Date.now()<a){let b=new Date(a);return{success:!1,error:`Handle can only be changed once every 6 months. Next change available on ${b.toLocaleDateString()}`,nextChangeDate:b}}}let l=await k(b,e);if(!l.isAvailable)return{success:!1,error:l.error||"Handle is not available"};if(h){let a=d.dbAdmin.collection("handles").doc(h);b.delete(a)}let m=d.dbAdmin.collection("handles").doc(e);b.set(m,{userId:a,userEmail:g.email,reservedAt:new Date,handle:e});let n={handle:e,lastHandleChange:new Date,handleChangeCount:(i||0)+1,updatedAt:new Date};return h&&(n.handleHistory=[...g.handleHistory||[],{handle:h,changedAt:new Date}]),b.update(c,n),{success:!0}})}catch(a){return f.v.error("Error changing handle",{component:"handle-service"},a instanceof Error?a:void 0),{success:!1,error:"Unable to change handle. Please try again."}}}async function o(a){if(h||!d.Gg)return{canChange:!0,changeCount:0,isFirstChangeFree:!0};try{let b=await g(()=>d.dbAdmin.collection("users").doc(a).get(),{operationName:"getHandleChangeStatus",maxRetries:3});if(!b.exists)return{canChange:!1,changeCount:0,isFirstChangeFree:!0};let c=b.data(),e=c.handleChangeCount||0,f=c.lastHandleChange;if(0===e)return{canChange:!0,changeCount:0,isFirstChangeFree:!0};if(f){let a=(f.toMillis?f.toMillis():new Date(f).getTime())+15552e6;if(Date.now()<a)return{canChange:!1,nextChangeDate:new Date(a),changeCount:e,isFirstChangeFree:!1}}return{canChange:!0,changeCount:e,isFirstChangeFree:!1}}catch(b){return f.v.error("Error getting handle change status",{component:"handle-service",userId:a},b instanceof Error?b:void 0),{canChange:!1,changeCount:0,isFirstChangeFree:!0}}}},29294:a=>{a.exports=require("next/dist/server/app-render/work-async-storage.external.js")},41460:(a,b,c)=>{c.a(a,async(a,d)=>{try{c.r(b),c.d(b,{GET:()=>q,PATCH:()=>s,POST:()=>t,PUT:()=>r});var e=c(54760),f=c(97338),g=c(73641),h=c(38929),i=c(94205),j=c(27810),k=c(70510),l=a([i,k]);[i,k]=l.then?(await l)():l;let n=k.V7.MAX_INTERESTS,o=e.Ik({handle:e.Yj().min(3).max(30).regex(/^[a-zA-Z0-9_-]+$/).optional(),firstName:e.Yj().min(1).max(50).optional(),lastName:e.Yj().min(1).max(50).optional(),fullName:e.Yj().min(1).max(100).optional(),bio:e.Yj().max(500).optional(),major:e.Yj().min(1).max(100).optional().transform(a=>{if(!a)return a;let b=k.W5.create(a);return b.isSuccess?b.getValue().value:a}),graduationYear:e.ai().int().optional().refine(a=>null==a||k.uQ.create(a).isSuccess,{message:"Graduation year must be between 2015 and 8 years from now"}),dorm:e.Yj().max(100).optional(),housing:e.Yj().max(200).optional(),pronouns:e.Yj().max(50).optional(),academicYear:e.Yj().max(50).optional(),interests:e.YO(e.Yj().min(2).max(50)).max(n).optional().transform(a=>{if(!a)return a;let b=k.V7.create(a);return b.isSuccess?b.getValue().toStringArray():a}),profileImageUrl:e.Yj().url().optional(),photos:e.YO(e.Yj().url()).max(5).optional(),statusMessage:e.Yj().max(200).optional(),currentVibe:e.Yj().max(100).optional(),availabilityStatus:e.k5(["online","studying","busy","away","invisible"]).optional(),lookingFor:e.YO(e.Yj()).optional(),builderOptIn:e.zM().optional(),builderAnalyticsEnabled:e.zM().optional(),isPublic:e.zM().optional(),showActivity:e.zM().optional(),showSpaces:e.zM().optional(),showConnections:e.zM().optional(),allowDirectMessages:e.zM().optional(),showOnlineStatus:e.zM().optional()}),p={cards:[{id:"spaces_hub",type:"spaces_hub",size:"2x1",visible:!0},{id:"friends_network",type:"friends_network",size:"2x1",visible:!0},{id:"active_now",type:"active_now",size:"1x1",visible:!0},{id:"discovery",type:"discovery",size:"1x1",visible:!0}],mobileLayout:[{id:"spaces_hub_mobile",type:"spaces_hub",size:"2x1",visible:!0},{id:"friends_network_mobile",type:"friends_network",size:"2x1",visible:!0}]},q=(0,i.lT)(async(a,b,c)=>{try{let b=(0,i.F6)(a),c=(0,i.rE)(a),d=new URL(a.url),e=(d.searchParams.get("include")||"").split(",").filter(Boolean),l=d.searchParams.get("id"),n=d.searchParams.get("handle"),o=b,q=(0,k.bV)();if(n){let a=await q.findByHandle(n.toLowerCase());if(a.isFailure)return g.NextResponse.json({success:!1,error:"Profile not found"},{status:404});o=a.getValue().id}else l&&(o=l);let r=o===b,s=await q.findById(o);if(s.isFailure){let a=await h.dbAdmin.collection("users").doc(o).get();if(!a.exists)return f.v.warn("Profile not found",{userId:o,endpoint:"/api/profile"}),g.NextResponse.json({success:!1,error:"Profile not found",needsOnboarding:r},{status:404});let b=a.data();return m(o,b,c,r,e)}let t=s.getValue(),u=r?await (0,j.ng)(o):null,v=null;if(e.includes("grid")){let a=(await h.dbAdmin.collection("users").doc(o).get()).data();v=a?.profileGrid||{...p,lastModified:new Date().toISOString()}}let w={success:!0,data:{id:t.profileId.value,email:t.email.value,handle:t.handle.value,firstName:t.firstName,lastName:t.lastName,fullName:t.displayName,bio:t.bio||"",major:t.major||"",graduationYear:t.graduationYear||null,dorm:t.personalInfo.dorm||"",interests:t.interests||[],profileImageUrl:t.personalInfo.profilePhoto||"",coverPhoto:t.personalInfo.coverPhoto||"",photos:t.photos||[],clubs:t.socialInfo.clubs||[],sports:t.socialInfo.sports||[],greek:t.socialInfo.greek||"",socials:{instagram:t.socialInfo.instagram||"",snapchat:t.socialInfo.snapchat||"",twitter:t.socialInfo.twitter||"",linkedin:t.socialInfo.linkedin||""},statusMessage:"",currentVibe:"",availabilityStatus:"online",lookingFor:[],onboardingStatus:{isComplete:t.isOnboarded,currentStep:t.isOnboarded?999:1},privacy:{level:t.privacy.level,isPublic:t.privacy.level===k.tl.PUBLIC,showEmail:t.privacy.showEmail,showPhone:t.privacy.showPhone,showDorm:t.privacy.showDorm,showSchedule:t.privacy.showSchedule,showActivity:t.privacy.showActivity,showSpaces:!0,showConnections:!0,allowDirectMessages:!0,showOnlineStatus:!0},stats:{connectionCount:t.connectionCount,followerCount:t.followerCount,followingCount:t.followingCount,activityScore:t.activityScore,spacesJoined:t.spaces.length},spaces:t.spaces||[],connections:t.connections||[],achievements:t.badges||[],metadata:{campusId:t.campusId.id,userType:t.userType.value,isVerified:t.isVerified,isActive:t.isActive,createdAt:t.createdAt?.toISOString()||new Date().toISOString(),updatedAt:t.updatedAt?.toISOString()||new Date().toISOString(),lastActive:t.lastActive?.toISOString()||null},handleChange:u?{canChange:u.canChange,nextChangeDate:u.nextChangeDate?.toISOString(),changeCount:u.changeCount,isFirstChangeFree:u.isFirstChangeFree}:void 0,completionPercentage:t.getCompletionPercentage()}};return e.includes("grid")&&v&&(w.grid=v),e.includes("viewer")&&(w.viewer={isOwnProfile:r,relationship:r?"self":"campus"}),e.includes("tools")&&(w.deployedTools=(await h.dbAdmin.collection("users").doc(o).collection("placed_tools").where("isActive","==",!0).orderBy("placedAt","desc").limit(20).get()).docs.map(a=>{let b=a.data();return{id:a.id,toolId:b.toolId,name:b.name||"Untitled Tool",description:b.description||"",icon:b.icon||"Wrench",deploymentId:a.id,isActive:b.isActive??!0,config:b.config||{},placedAt:b.placedAt||null}})),f.v.info("Profile fetched successfully via DDD",{handle:t.handle.value,endpoint:"/api/profile",includes:e,completionPercentage:w.data.completionPercentage}),g.NextResponse.json(w)}catch(a){return f.v.error("Error fetching profile",{error:{error:a instanceof Error?a.message:String(a)},endpoint:"/api/profile"}),g.NextResponse.json({success:!1,error:"Internal server error"},{status:500})}});async function m(a,b,c,d=!0,e=[]){let f=d?await (0,j.ng)(a):null,h={success:!0,data:{id:a,email:b.email,handle:b.handle,firstName:b.firstName,lastName:b.lastName,fullName:b.fullName||`${b.firstName||""} ${b.lastName||""}`.trim(),bio:b.bio,major:b.major,graduationYear:b.graduationYear,dorm:b.dorm,interests:b.interests||[],profileImageUrl:b.profileImageUrl,photos:b.photos||[],statusMessage:b.statusMessage,currentVibe:b.currentVibe,availabilityStatus:b.availabilityStatus||"online",lookingFor:b.lookingFor||[],onboardingStatus:{isComplete:b.onboardingComplete||!1,currentStep:b.onboardingStep||1},privacy:{isPublic:b.privacySettings?.isPublic??!0,showActivity:b.privacySettings?.showActivity??!0,showSpaces:b.privacySettings?.showSpaces??!0,showConnections:b.privacySettings?.showConnections??!0,allowDirectMessages:b.privacySettings?.allowDirectMessages??!0,showOnlineStatus:b.privacySettings?.showOnlineStatus??!0},stats:{connectionCount:b.connections?.length||0,spacesJoined:b.spaceIds?.length||0},metadata:{campusId:b.campusId||c,createdAt:b.createdAt?.toDate?.()?.toISOString()||new Date().toISOString(),updatedAt:b.updatedAt?.toDate?.()?.toISOString()||new Date().toISOString()},handleChange:f?{canChange:f.canChange,nextChangeDate:f.nextChangeDate?.toISOString(),changeCount:f.changeCount,isFirstChangeFree:f.isFirstChangeFree}:void 0},_legacy:!0};return e.includes("grid")&&(h.grid=b.profileGrid||{...p,lastModified:new Date().toISOString()}),e.includes("viewer")&&(h.viewer={isOwnProfile:d,relationship:d?"self":"campus"}),g.NextResponse.json(h)}let r=(0,i.lT)(async(a,b,d)=>{try{let b=(0,i.F6)(a),d=(0,i.rE)(a),e=await a.json(),l=o.parse(e);if(f.v.info("Profile update request",{fields:Object.keys(l),endpoint:"/api/profile"}),l.handle){let a=await (0,j.ZD)(b,l.handle);if(!a.success)return g.NextResponse.json({success:!1,error:a.error,nextChangeDate:a.nextChangeDate?.toISOString()},{status:400});delete l.handle}let m=(0,k.bV)(),n=await m.findById(b);if(n.isSuccess){let a=n.getValue(),d=!1,e={...void 0!==l.firstName&&{firstName:l.firstName},...void 0!==l.lastName&&{lastName:l.lastName},...void 0!==l.bio&&{bio:l.bio},...void 0!==l.major&&{major:l.major},...void 0!==l.graduationYear&&{graduationYear:l.graduationYear},...void 0!==l.dorm&&{dorm:l.dorm},...void 0!==l.pronouns&&{pronouns:l.pronouns},...void 0!==l.profileImageUrl&&{profilePhoto:l.profileImageUrl}};Object.keys(e).length>0&&(a.updatePersonalInfo(e),d=!0);let h={...void 0!==l.interests&&{interests:l.interests}};if(Object.keys(h).length>0&&(a.updateSocialInfo(h),d=!0),void 0!==l.isPublic||void 0!==l.showActivity||void 0!==l.showSpaces||void 0!==l.showConnections||void 0!==l.allowDirectMessages||void 0!==l.showOnlineStatus){let b=a.privacy,e={level:void 0!==l.isPublic?l.isPublic?k.tl.PUBLIC:k.tl.CAMPUS_ONLY:b.level,showEmail:b.showEmail,showPhone:b.showPhone,showDorm:b.showDorm,showSchedule:b.showSchedule,showActivity:l.showActivity??b.showActivity},{ProfilePrivacy:f}=await Promise.resolve().then(c.bind(c,70510)),g=f.create(e);g.isSuccess&&(a.updatePrivacy(g.getValue()),d=!0)}if(d){let c=await m.save(a);if(!c.isFailure)return f.v.info("Profile updated successfully via DDD",{fieldsUpdated:Object.keys(l),endpoint:"/api/profile"}),g.NextResponse.json({success:!0,message:"Profile updated successfully",data:{id:b,updatedFields:Object.keys(l),completionPercentage:a.getCompletionPercentage()}});f.v.warn("DDD save failed, falling back to direct update",{error:c.error,userId:b})}}let p={...l,updatedAt:new Date,campusId:d};if(void 0!==l.isPublic||void 0!==l.showActivity||void 0!==l.showSpaces||void 0!==l.showConnections||void 0!==l.allowDirectMessages||void 0!==l.showOnlineStatus){let a=await h.dbAdmin.collection("users").doc(b).get();p.privacySettings={...a.data()?.privacySettings||{},...void 0!==l.isPublic&&{isPublic:l.isPublic},...void 0!==l.showActivity&&{showActivity:l.showActivity},...void 0!==l.showSpaces&&{showSpaces:l.showSpaces},...void 0!==l.showConnections&&{showConnections:l.showConnections},...void 0!==l.allowDirectMessages&&{allowDirectMessages:l.allowDirectMessages},...void 0!==l.showOnlineStatus&&{showOnlineStatus:l.showOnlineStatus}},delete p.isPublic,delete p.showActivity,delete p.showSpaces,delete p.showConnections,delete p.allowDirectMessages,delete p.showOnlineStatus}return await h.dbAdmin.collection("users").doc(b).update(p),f.v.info("Profile updated successfully (fallback)",{fieldsUpdated:Object.keys(l),endpoint:"/api/profile"}),g.NextResponse.json({success:!0,message:"Profile updated successfully",data:{id:b,updatedFields:Object.keys(l)}})}catch(a){return f.v.error("Error updating profile",{error:{error:a instanceof Error?a.message:String(a)},endpoint:"/api/profile"}),g.NextResponse.json({success:!1,error:"Internal server error"},{status:500})}}),s=r,t=r;d()}catch(a){d(a)}})},44870:a=>{a.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},46675:a=>{a.exports=require("firebase-admin")},55511:a=>{a.exports=require("crypto")},57975:a=>{a.exports=require("node:util")},63033:a=>{a.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},77598:a=>{a.exports=require("node:crypto")},86439:a=>{a.exports=require("next/dist/shared/lib/no-fallback-error.external")},95859:(a,b,c)=>{c.a(a,async(a,d)=>{try{c.r(b),c.d(b,{handler:()=>x,patchFetch:()=>w,routeModule:()=>y,serverHooks:()=>B,workAsyncStorage:()=>z,workUnitAsyncStorage:()=>A});var e=c(98128),f=c(48869),g=c(78868),h=c(37526),i=c(21884),j=c(261),k=c(24218),l=c(73640),m=c(66376),n=c(36363),o=c(73605),p=c(76583),q=c(19465),r=c(78910),s=c(86439),t=c(48724),u=c(41460),v=a([u]);u=(v.then?(await v)():v)[0];let y=new e.AppRouteRouteModule({definition:{kind:f.RouteKind.APP_ROUTE,page:"/api/profile/route",pathname:"/api/profile",filename:"route",bundlePath:"app/api/profile/route"},distDir:".next",relativeProjectDir:"",resolvedPagePath:"/Users/laneyfraass/Desktop/HIVE/apps/web/src/app/api/profile/route.ts",nextConfigOutput:"",userland:u}),{workAsyncStorage:z,workUnitAsyncStorage:A,serverHooks:B}=y;function w(){return(0,g.patchFetch)({workAsyncStorage:z,workUnitAsyncStorage:A})}async function x(a,b,c){var d;let e="/api/profile/route";"/index"===e&&(e="/");let g=await y.prepare(a,b,{srcPage:e,multiZoneDraftMode:!1});if(!g)return b.statusCode=400,b.end("Bad Request"),null==c.waitUntil||c.waitUntil.call(c,Promise.resolve()),null;let{buildId:u,params:v,nextConfig:w,isDraftMode:x,prerenderManifest:z,routerServerContext:A,isOnDemandRevalidate:B,revalidateOnlyGenerated:C,resolvedPathname:D}=g,E=(0,j.normalizeAppPath)(e),F=!!(z.dynamicRoutes[E]||z.routes[D]);if(F&&!x){let a=!!z.routes[D],b=z.dynamicRoutes[E];if(b&&!1===b.fallback&&!a)throw new s.NoFallbackError}let G=null;!F||y.isDev||x||(G=D,G="/index"===G?"/":G);let H=!0===y.isDev||!F,I=F&&!H,J=a.method||"GET",K=(0,i.getTracer)(),L=K.getActiveScopeSpan(),M={params:v,prerenderManifest:z,renderOpts:{experimental:{cacheComponents:!!w.experimental.cacheComponents,authInterrupts:!!w.experimental.authInterrupts},supportsDynamicResponse:H,incrementalCache:(0,h.getRequestMeta)(a,"incrementalCache"),cacheLifeProfiles:null==(d=w.experimental)?void 0:d.cacheLife,isRevalidate:I,waitUntil:c.waitUntil,onClose:a=>{b.on("close",a)},onAfterTaskError:void 0,onInstrumentationRequestError:(b,c,d)=>y.onRequestError(a,b,d,A)},sharedContext:{buildId:u}},N=new k.NodeNextRequest(a),O=new k.NodeNextResponse(b),P=l.NextRequestAdapter.fromNodeNextRequest(N,(0,l.signalFromNodeResponse)(b));try{let d=async c=>y.handle(P,M).finally(()=>{if(!c)return;c.setAttributes({"http.status_code":b.statusCode,"next.rsc":!1});let d=K.getRootSpanAttributes();if(!d)return;if(d.get("next.span_type")!==m.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${d.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let e=d.get("next.route");if(e){let a=`${J} ${e}`;c.setAttributes({"next.route":e,"http.route":e,"next.span_name":a}),c.updateName(a)}else c.updateName(`${J} ${a.url}`)}),g=async g=>{var i,j;let k=async({previousCacheEntry:f})=>{try{if(!(0,h.getRequestMeta)(a,"minimalMode")&&B&&C&&!f)return b.statusCode=404,b.setHeader("x-nextjs-cache","REVALIDATED"),b.end("This page could not be found"),null;let e=await d(g);a.fetchMetrics=M.renderOpts.fetchMetrics;let i=M.renderOpts.pendingWaitUntil;i&&c.waitUntil&&(c.waitUntil(i),i=void 0);let j=M.renderOpts.collectedTags;if(!F)return await (0,o.I)(N,O,e,M.renderOpts.pendingWaitUntil),null;{let a=await e.blob(),b=(0,p.toNodeOutgoingHttpHeaders)(e.headers);j&&(b[r.NEXT_CACHE_TAGS_HEADER]=j),!b["content-type"]&&a.type&&(b["content-type"]=a.type);let c=void 0!==M.renderOpts.collectedRevalidate&&!(M.renderOpts.collectedRevalidate>=r.INFINITE_CACHE)&&M.renderOpts.collectedRevalidate,d=void 0===M.renderOpts.collectedExpire||M.renderOpts.collectedExpire>=r.INFINITE_CACHE?void 0:M.renderOpts.collectedExpire;return{value:{kind:t.CachedRouteKind.APP_ROUTE,status:e.status,body:Buffer.from(await a.arrayBuffer()),headers:b},cacheControl:{revalidate:c,expire:d}}}}catch(b){throw(null==f?void 0:f.isStale)&&await y.onRequestError(a,b,{routerKind:"App Router",routePath:e,routeType:"route",revalidateReason:(0,n.c)({isRevalidate:I,isOnDemandRevalidate:B})},A),b}},l=await y.handleResponse({req:a,nextConfig:w,cacheKey:G,routeKind:f.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:z,isRoutePPREnabled:!1,isOnDemandRevalidate:B,revalidateOnlyGenerated:C,responseGenerator:k,waitUntil:c.waitUntil});if(!F)return null;if((null==l||null==(i=l.value)?void 0:i.kind)!==t.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==l||null==(j=l.value)?void 0:j.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});(0,h.getRequestMeta)(a,"minimalMode")||b.setHeader("x-nextjs-cache",B?"REVALIDATED":l.isMiss?"MISS":l.isStale?"STALE":"HIT"),x&&b.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let m=(0,p.fromNodeOutgoingHttpHeaders)(l.value.headers);return(0,h.getRequestMeta)(a,"minimalMode")&&F||m.delete(r.NEXT_CACHE_TAGS_HEADER),!l.cacheControl||b.getHeader("Cache-Control")||m.get("Cache-Control")||m.set("Cache-Control",(0,q.getCacheControlHeader)(l.cacheControl)),await (0,o.I)(N,O,new Response(l.value.body,{headers:m,status:l.value.status||200})),null};L?await g(L):await K.withPropagatedContext(a.headers,()=>K.trace(m.BaseServerSpan.handleRequest,{spanName:`${J} ${a.url}`,kind:i.SpanKind.SERVER,attributes:{"http.method":J,"http.target":a.url}},g))}catch(b){if(b instanceof s.NoFallbackError||await y.onRequestError(a,b,{routerKind:"App Router",routePath:E,routeType:"route",revalidateReason:(0,n.c)({isRevalidate:I,isOnDemandRevalidate:B})}),F)throw b;return await (0,o.I)(N,O,new Response(null,{status:500})),null}}d()}catch(a){d(a)}})}};var b=require("../../../webpack-runtime.js");b.C(a);var c=b.X(0,[7545,1684,5524,2845,4760,3272,2269,4205,6513,4918,3928,510],()=>b(b.s=95859));module.exports=c})();