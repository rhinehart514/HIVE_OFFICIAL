"use strict";(()=>{var a={};a.id=6356,a.ids=[6356],a.modules={261:a=>{a.exports=require("next/dist/shared/lib/router/utils/app-paths")},3295:a=>{a.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},4573:a=>{a.exports=require("node:buffer")},7835:(a,b,c)=>{c.a(a,async(a,d)=>{try{c.r(b),c.d(b,{GET:()=>u,PATCH:()=>v});var e=c(54760),f=c(38929),g=c(91714),h=c(94205),i=c(25384),j=c(70510),k=a([h,j]);[h,j]=k.then?(await k)():k;let l={self:4,friend:3,connection:2,campus:1},m={public:0,campus:1,connections:2,friends:3,private:4,ghost:4},n={cards:[{id:"spaces_hub",type:"spaces_hub",size:"2x1",visible:!0},{id:"friends_network",type:"friends_network",size:"2x1",visible:!0},{id:"active_now",type:"active_now",size:"1x1",visible:!0},{id:"discovery",type:"discovery",size:"1x1",visible:!0}],mobileLayout:[{id:"spaces_hub_mobile",type:"spaces_hub",size:"2x1",visible:!0},{id:"friends_network_mobile",type:"friends_network",size:"2x1",visible:!0}]},o=e.Ik({cards:e.YO(e.Ik({id:e.Yj(),type:e.Yj(),size:e.k5(["1x1","1x2","2x1","2x2"]).default("1x1"),position:e.ai().optional(),visible:e.zM().optional(),customType:e.Yj().optional(),title:e.Yj().optional()})).default(n.cards),mobileLayout:e.YO(e.Ik({id:e.Yj(),type:e.Yj(),size:e.k5(["1x1","1x2","2x1","2x2"]).default("1x1"),position:e.ai().optional(),visible:e.zM().optional(),customType:e.Yj().optional(),title:e.Yj().optional()})).default(n.mobileLayout),lastModified:e.KC([e.Yj(),e.ai(),e.p6()]).optional()}),p=e.Ik({privacy:e.g1(e.L5()).optional(),grid:o.optional()}),q=a=>{if(!a)return null;if("string"==typeof a)return a;if(a instanceof Date)return a.toISOString();if("object"==typeof a&&null!==a&&"toDate"in a&&"function"==typeof a.toDate)try{return a.toDate().toISOString()}catch(a){g.vF.warn("Failed to convert Firestore timestamp",{error:a instanceof Error?a.message:String(a)})}return null},r=a=>{if(!a)return{...n,lastModified:new Date().toISOString()};let b=o.safeParse(a);if(!b.success)return g.vF.warn("Invalid profile grid stored in Firestore; defaulting",{error:b.error.message,issues:JSON.stringify(b.error.issues)}),{...n,lastModified:new Date().toISOString()};let c=b.data.lastModified?q(b.data.lastModified):null;return{cards:b.data.cards,mobileLayout:b.data.mobileLayout,lastModified:c??new Date().toISOString()}},s=(a,b,c)=>{let d=b?.widgets,e=b?.[a],f=d?.[a]?.level??e?.level;if("string"==typeof f)return f;switch(a){case"activity":return b?.showActivity===!1?"private":"connections";case"spaces":return b?.showSpaces===!1?"private":"connections";case"connections":return b?.showConnections===!1?"private":"connections";case"discovery":return"campus";default:return c.level}},t=(a,b)=>{if(!b)return!0;if("private"===b||"ghost"===b)return"self"===a;let c=l[a]??0,d=m[b]??0;return c>=d},u=(0,h.lT)(async(a,b,c)=>{try{let b,d=(0,h.F6)(a),{searchParams:e}=new URL(a.url),k=e.get("id"),l=e.get("handle"),m=k||null;if(!m&&l){let a=await f.dbAdmin.collection("users").where("handle","==",l).where("campusId","==",i.e3).limit(1).get();if(a.empty)return c.error("Profile not found","RESOURCE_NOT_FOUND",{status:404});m=a.docs[0].id}m||(m=d);let n=f.dbAdmin.collection("users").doc(m),o=m===d,p=(0,j.bV)(),u=await p.findById(m),v=o?null:await n.collection("connections").doc(d).get().catch(()=>null),w=((a,b)=>a?"self":b?.exists&&b.data()?.isFriend?"friend":b?.exists?"connection":"campus")(o,v),x=(a=>{switch(a){case"self":case"friend":case"connection":return"connection";default:return"campus"}})(w),y={},z=null;if(u.isSuccess){let a=u.getValue();if(z=a.privacy,a.campusId.id!==i.e3)return c.error("Profile not found","RESOURCE_NOT_FOUND",{status:404});if(!o&&!z.canViewProfile(x))return g.vF.info("Profile access denied by DDD privacy",{targetUserId:m,viewerId:d,viewerType:x,privacyLevel:z.level}),c.error("Profile not found","RESOURCE_NOT_FOUND",{status:404});y={handle:a.handle.value,firstName:a.firstName,lastName:a.lastName,fullName:a.displayName,bio:a.bio||"",major:a.major||"",graduationYear:a.graduationYear,interests:a.interests,avatarUrl:a.personalInfo.profilePhoto,profileImageUrl:a.personalInfo.profilePhoto,pronouns:void a.personalInfo.dorm,badges:a.badges,campusId:a.campusId.id,connectionCount:a.connectionCount,privacySettings:{level:z.level,showEmail:z.showEmail,showPhone:z.showPhone,showDorm:z.showDorm,showSchedule:z.showSchedule,showActivity:z.showActivity}},g.vF.debug("Profile loaded via DDD repository",{targetUserId:m,handle:a.handle.value,privacyLevel:z.level})}else{let a=await n.get();if(!a.exists||(y=a.data()||{}).campusId&&y.campusId!==i.e3)return c.error("Profile not found","RESOURCE_NOT_FOUND",{status:404});g.vF.debug("Profile loaded via Firestore fallback",{targetUserId:m})}let[A,B]=await Promise.all([f.dbAdmin.collection("privacySettings").doc(m).get().catch(()=>null),f.dbAdmin.collection("presence").doc(m).get().catch(()=>null)]),C={...y.privacySettings||{},...y.privacy||{},...A?.exists?A.data():{}};if(z)switch(z.level){case j.tl.PUBLIC:b="public";break;case j.tl.CAMPUS_ONLY:b="campus";break;case j.tl.CONNECTIONS_ONLY:b="connections";break;case j.tl.PRIVATE:b="private";break;default:b="campus"}else{let a=C?.profile;if(b="string"==typeof a?.level?a.level:C?.isPublic===!1?"connections":"public",!t(w,b))return c.error("Profile not found","RESOURCE_NOT_FOUND",{status:404})}let D=r(y.profileGrid),E={activity:s("activity",C,{level:"connections"}),spaces:s("spaces",C,{level:"connections"}),connections:s("connections",C,{level:"connections"}),discovery:s("discovery",C,{level:"campus"})},[F,G,H]=await Promise.all([f.dbAdmin.collection("spaces").where("campusId","==",i.e3).where("members","array-contains",m).limit(8).get().catch(()=>({empty:!0,docs:[]})),n.collection("connections").orderBy("connectedAt","desc").limit(8).get().catch(()=>({empty:!0,docs:[]})),f.dbAdmin.collection("spaces").where("campusId","==",i.e3).orderBy("memberCount","desc").limit(6).get().catch(()=>({empty:!0,docs:[]}))]),I=F.docs.map(a=>{let b=a.data(),c=Array.isArray(b.members)?b.members:[],d=Array.isArray(b.leaders)?b.leaders:[];return{id:a.id,name:b.name??"Campus Space",role:d.includes(m)?"Lead":c.includes(m)?"Member":"Participant",memberCount:b.memberCount??c.length??0,lastActivityAt:q(b.lastActivityAt)??new Date().toISOString(),headline:b.tagline??b.subtitle??""}}),J=G.docs.map(a=>{let b=a.data();return{id:a.id,name:b.displayName||b.fullName||"Student",avatarUrl:b.avatarUrl||null,sharedSpaces:Array.isArray(b.sharedSpaces)?b.sharedSpaces:[],isFriend:!0===b.isFriend,connectionStrength:b.connectionStrength??b.strength??0,mutualConnections:b.mutualConnections??0,lastInteractionAt:q(b.lastInteraction)}}),K=H.docs.map(a=>({id:a.id,...a.data()||{}})).filter(a=>{if("object"!=typeof a||null===a)return!1;if(!("members"in a))return!0;let b=a.members;return!Array.isArray(b)||!b.includes(m)}).slice(0,3).map(a=>({id:"object"==typeof a&&null!==a&&"id"in a?String(a.id):"",name:"object"==typeof a&&null!==a&&"name"in a&&"string"==typeof a.name?a.name:"Campus Space",reason:"object"==typeof a&&null!==a&&"matchReason"in a&&"string"==typeof a.matchReason?a.matchReason:"Popular on campus",category:"object"==typeof a&&null!==a&&"category"in a&&"string"==typeof a.category?a.category:"space"})),L=J.filter(a=>a.isFriend).length,M=y.stats||{},N={spacesJoined:I.length,connections:y.connectionCount??J.length,friends:y.friendCount??L,toolsCreated:y.toolsCreated??M.toolsCreated??0,toolsUsed:y.toolsUsed??M.toolsUsed??I.filter(a=>Array.isArray(a.tools)&&a.tools.length>0).length??0,activeRituals:y.activeRituals??M.activeRituals??0,reputation:y.reputation??M.reputation??68,currentStreak:y.currentStreak??M.currentStreak??0},O=B?.exists?B.data():null,P={id:m,handle:y.handle||"",fullName:y.fullName||`${y.firstName||""} ${y.lastName||""}`.trim()||"Student",firstName:y.firstName||"",lastName:y.lastName||"",campusId:y.campusId||i.e3,avatarUrl:y.avatarUrl||y.profileImageUrl||null,pronouns:y.pronouns||null,bio:y.bio||"",major:y.major||"",graduationYear:y.graduationYear||null,interests:Array.isArray(y.interests)?y.interests:[],badges:Array.isArray(y.badges)?y.badges:[],presence:{status:O?.status||"offline",lastSeen:q(O?.lastSeen),isGhostMode:O?.isGhostMode??C?.ghostMode??!1},stats:N},Q=t(w,E.spaces),R=t(w,E.connections),S=t(w,E.activity),T=t(w,E.discovery),U=S?I.slice(0,4).map(a=>({id:`${a.id}-activity`,type:"space",spaceId:a.id,spaceName:a.name,action:"active",timestamp:a.lastActivityAt})):[];return c.success({profile:P,grid:D,stats:N,spaces:Q?I:[],connections:R?J:[],activities:U,intelligence:T?{suggestions:K}:{suggestions:[]},viewer:{relationship:w,isOwnProfile:o,isConnection:"connection"===w||"friend"===w,isFriend:"friend"===w},privacy:{profileLevel:b,widgets:E}})}catch(a){return g.vF.error("Failed to fetch profile v2",{error:a instanceof Error?a.message:String(a)}),c.error("Failed to fetch profile","INTERNAL_ERROR",{status:500})}}),v=(0,h.lT)(async(a,b,c)=>{try{let b=(0,h.F6)(a),d=await a.json(),e=p.parse(d),k=[],l=[],m=!1;if(e.privacy){let a=(0,j.bV)(),c=await a.findById(b);if(c.isSuccess){let d=c.getValue(),f=d.privacy,h=e.privacy,i=h.level?(a=>{switch(a){case"public":return j.tl.PUBLIC;case"campus":case"campus_only":default:return j.tl.CAMPUS_ONLY;case"connections":case"connections_only":case"friends":return j.tl.CONNECTIONS_ONLY;case"private":case"ghost":return j.tl.PRIVATE}})(h.level):f.level,k=j.ProfilePrivacy.create({level:i,showEmail:"boolean"==typeof h.showEmail?h.showEmail:f.showEmail,showPhone:"boolean"==typeof h.showPhone?h.showPhone:f.showPhone,showDorm:"boolean"==typeof h.showDorm?h.showDorm:f.showDorm,showSchedule:"boolean"==typeof h.showSchedule?h.showSchedule:f.showSchedule,showActivity:"boolean"==typeof h.showActivity?h.showActivity:f.showActivity});if(k.isSuccess){d.updatePrivacy(k.getValue());let c=await a.save(d);c.isSuccess?(l=l.concat(Object.keys(e.privacy)),m=!0,g.vF.info("Privacy updated via DDD",{userId:b,fields:Object.keys(e.privacy)})):g.vF.warn("DDD save failed, falling back to direct update",{userId:b,error:c.error})}}if(!m){let a=f.dbAdmin.collection("privacySettings").doc(b),c=await a.get(),d=new Date().toISOString(),g={...c.exists?c.data():{},...e.privacy,userId:b,updatedAt:d,campusId:c.data()?.campusId||i.e3};c.exists||(g.createdAt=d),k.push(a.set(g,{merge:!0})),l=l.concat(Object.keys(e.privacy))}}if(e.grid){let a=r(e.grid);k.push(f.dbAdmin.collection("users").doc(b).set({profileGrid:a},{merge:!0})),l.push("grid")}if(0===k.length)return c.success({message:"No changes applied",fieldsUpdated:[]});return await Promise.all(k),c.success({fieldsUpdated:l,message:"Profile updated"})}catch(a){return g.vF.error("Failed to update profile v2",{error:a instanceof Error?a.message:String(a)}),c.error("Failed to update profile","INTERNAL_ERROR",{status:500})}});d()}catch(a){d(a)}})},7879:a=>{a.exports=import("firebase-admin/firestore")},10846:a=>{a.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},14276:a=>{a.exports=import("firebase-admin/auth")},19121:a=>{a.exports=require("next/dist/server/app-render/action-async-storage.external.js")},29294:a=>{a.exports=require("next/dist/server/app-render/work-async-storage.external.js")},37145:(a,b,c)=>{c.a(a,async(a,d)=>{try{c.r(b),c.d(b,{handler:()=>x,patchFetch:()=>w,routeModule:()=>y,serverHooks:()=>B,workAsyncStorage:()=>z,workUnitAsyncStorage:()=>A});var e=c(98128),f=c(48869),g=c(78868),h=c(37526),i=c(21884),j=c(261),k=c(24218),l=c(73640),m=c(66376),n=c(36363),o=c(73605),p=c(76583),q=c(19465),r=c(78910),s=c(86439),t=c(48724),u=c(7835),v=a([u]);u=(v.then?(await v)():v)[0];let y=new e.AppRouteRouteModule({definition:{kind:f.RouteKind.APP_ROUTE,page:"/api/profile/v2/route",pathname:"/api/profile/v2",filename:"route",bundlePath:"app/api/profile/v2/route"},distDir:".next",relativeProjectDir:"",resolvedPagePath:"/Users/laneyfraass/Desktop/HIVE/apps/web/src/app/api/profile/v2/route.ts",nextConfigOutput:"",userland:u}),{workAsyncStorage:z,workUnitAsyncStorage:A,serverHooks:B}=y;function w(){return(0,g.patchFetch)({workAsyncStorage:z,workUnitAsyncStorage:A})}async function x(a,b,c){var d;let e="/api/profile/v2/route";"/index"===e&&(e="/");let g=await y.prepare(a,b,{srcPage:e,multiZoneDraftMode:!1});if(!g)return b.statusCode=400,b.end("Bad Request"),null==c.waitUntil||c.waitUntil.call(c,Promise.resolve()),null;let{buildId:u,params:v,nextConfig:w,isDraftMode:x,prerenderManifest:z,routerServerContext:A,isOnDemandRevalidate:B,revalidateOnlyGenerated:C,resolvedPathname:D}=g,E=(0,j.normalizeAppPath)(e),F=!!(z.dynamicRoutes[E]||z.routes[D]);if(F&&!x){let a=!!z.routes[D],b=z.dynamicRoutes[E];if(b&&!1===b.fallback&&!a)throw new s.NoFallbackError}let G=null;!F||y.isDev||x||(G=D,G="/index"===G?"/":G);let H=!0===y.isDev||!F,I=F&&!H,J=a.method||"GET",K=(0,i.getTracer)(),L=K.getActiveScopeSpan(),M={params:v,prerenderManifest:z,renderOpts:{experimental:{cacheComponents:!!w.experimental.cacheComponents,authInterrupts:!!w.experimental.authInterrupts},supportsDynamicResponse:H,incrementalCache:(0,h.getRequestMeta)(a,"incrementalCache"),cacheLifeProfiles:null==(d=w.experimental)?void 0:d.cacheLife,isRevalidate:I,waitUntil:c.waitUntil,onClose:a=>{b.on("close",a)},onAfterTaskError:void 0,onInstrumentationRequestError:(b,c,d)=>y.onRequestError(a,b,d,A)},sharedContext:{buildId:u}},N=new k.NodeNextRequest(a),O=new k.NodeNextResponse(b),P=l.NextRequestAdapter.fromNodeNextRequest(N,(0,l.signalFromNodeResponse)(b));try{let d=async c=>y.handle(P,M).finally(()=>{if(!c)return;c.setAttributes({"http.status_code":b.statusCode,"next.rsc":!1});let d=K.getRootSpanAttributes();if(!d)return;if(d.get("next.span_type")!==m.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${d.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let e=d.get("next.route");if(e){let a=`${J} ${e}`;c.setAttributes({"next.route":e,"http.route":e,"next.span_name":a}),c.updateName(a)}else c.updateName(`${J} ${a.url}`)}),g=async g=>{var i,j;let k=async({previousCacheEntry:f})=>{try{if(!(0,h.getRequestMeta)(a,"minimalMode")&&B&&C&&!f)return b.statusCode=404,b.setHeader("x-nextjs-cache","REVALIDATED"),b.end("This page could not be found"),null;let e=await d(g);a.fetchMetrics=M.renderOpts.fetchMetrics;let i=M.renderOpts.pendingWaitUntil;i&&c.waitUntil&&(c.waitUntil(i),i=void 0);let j=M.renderOpts.collectedTags;if(!F)return await (0,o.I)(N,O,e,M.renderOpts.pendingWaitUntil),null;{let a=await e.blob(),b=(0,p.toNodeOutgoingHttpHeaders)(e.headers);j&&(b[r.NEXT_CACHE_TAGS_HEADER]=j),!b["content-type"]&&a.type&&(b["content-type"]=a.type);let c=void 0!==M.renderOpts.collectedRevalidate&&!(M.renderOpts.collectedRevalidate>=r.INFINITE_CACHE)&&M.renderOpts.collectedRevalidate,d=void 0===M.renderOpts.collectedExpire||M.renderOpts.collectedExpire>=r.INFINITE_CACHE?void 0:M.renderOpts.collectedExpire;return{value:{kind:t.CachedRouteKind.APP_ROUTE,status:e.status,body:Buffer.from(await a.arrayBuffer()),headers:b},cacheControl:{revalidate:c,expire:d}}}}catch(b){throw(null==f?void 0:f.isStale)&&await y.onRequestError(a,b,{routerKind:"App Router",routePath:e,routeType:"route",revalidateReason:(0,n.c)({isRevalidate:I,isOnDemandRevalidate:B})},A),b}},l=await y.handleResponse({req:a,nextConfig:w,cacheKey:G,routeKind:f.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:z,isRoutePPREnabled:!1,isOnDemandRevalidate:B,revalidateOnlyGenerated:C,responseGenerator:k,waitUntil:c.waitUntil});if(!F)return null;if((null==l||null==(i=l.value)?void 0:i.kind)!==t.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==l||null==(j=l.value)?void 0:j.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});(0,h.getRequestMeta)(a,"minimalMode")||b.setHeader("x-nextjs-cache",B?"REVALIDATED":l.isMiss?"MISS":l.isStale?"STALE":"HIT"),x&&b.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let m=(0,p.fromNodeOutgoingHttpHeaders)(l.value.headers);return(0,h.getRequestMeta)(a,"minimalMode")&&F||m.delete(r.NEXT_CACHE_TAGS_HEADER),!l.cacheControl||b.getHeader("Cache-Control")||m.get("Cache-Control")||m.set("Cache-Control",(0,q.getCacheControlHeader)(l.cacheControl)),await (0,o.I)(N,O,new Response(l.value.body,{headers:m,status:l.value.status||200})),null};L?await g(L):await K.withPropagatedContext(a.headers,()=>K.trace(m.BaseServerSpan.handleRequest,{spanName:`${J} ${a.url}`,kind:i.SpanKind.SERVER,attributes:{"http.method":J,"http.target":a.url}},g))}catch(b){if(b instanceof s.NoFallbackError||await y.onRequestError(a,b,{routerKind:"App Router",routePath:E,routeType:"route",revalidateReason:(0,n.c)({isRevalidate:I,isOnDemandRevalidate:B})}),F)throw b;return await (0,o.I)(N,O,new Response(null,{status:500})),null}}d()}catch(a){d(a)}})},44870:a=>{a.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},46675:a=>{a.exports=require("firebase-admin")},55511:a=>{a.exports=require("crypto")},57975:a=>{a.exports=require("node:util")},63033:a=>{a.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},77598:a=>{a.exports=require("node:crypto")},86439:a=>{a.exports=require("next/dist/shared/lib/no-fallback-error.external")}};var b=require("../../../../webpack-runtime.js");b.C(a);var c=b.X(0,[7545,1684,5524,2845,4760,3272,2269,4205,5384,6513,4918,3928,510],()=>b(b.s=37145));module.exports=c})();