# Custom Blocks Design

**Phase 5 of HiveLab Architecture**
**Status:** Design Complete, Implementation Pending
**Owner:** custom-blocks specialist

---

## Overview

Custom blocks allow AI-generated HTML/CSS/JS to run safely within HIVE tools through iframe sandboxing. This enables unlimited UI possibilities while maintaining security and design consistency.

### Key Principles

1. **Sandboxed execution** — No network requests, no localStorage, no parent DOM access
2. **Design token injection** — HIVE design system automatically available in sandbox
3. **postMessage bridge** — Type-safe communication via HIVE SDK
4. **Hybrid composition** — Mix native elements with custom blocks seamlessly
5. **Versioned immutability** — Code bundles are immutable, versions tracked

---

## Element Type

Custom blocks are a new element type added to the HiveLab element registry.

### Element ID
`custom-block`

### Category
`action` (can contain interactive UI)

### Capabilities
- **Stateful:** Yes (via HIVE SDK state management)
- **Realtime:** Yes (via postMessage bridge)
- **Supports Actions:** Custom actions defined in block manifest
- **Inputs/Outputs:** Defined per block in manifest

---

## Schema Design

### CustomBlockConfig

```typescript
/**
 * Configuration for a custom block element instance
 */
interface CustomBlockConfig {
  /**
   * Unique block identifier (generated by AI or creator)
   * Format: "block_{uuid}"
   */
  blockId: string;

  /**
   * Current version of the block code
   * Incremented on each edit/regeneration
   */
  version: number;

  /**
   * Block metadata
   */
  metadata: {
    /** Human-readable name */
    name: string;

    /** What this block does */
    description: string;

    /** AI-generated or user-provided */
    createdBy: 'ai' | 'user';

    /** Timestamp of creation */
    createdAt: string;

    /** Timestamp of last update */
    updatedAt: string;
  };

  /**
   * Code bundle for this version
   * Contains HTML, CSS, and JS
   */
  code: CustomBlockCode;

  /**
   * Block capabilities and interface
   */
  manifest: CustomBlockManifest;

  /**
   * CSP overrides (restrictive by default)
   * Only allow specific domains if needed
   */
  csp?: {
    /** Allow specific image sources (e.g., ['https://cdn.example.com']) */
    imgSrc?: string[];

    /** Allow specific font sources */
    fontSrc?: string[];
  };
}

/**
 * Code bundle for a custom block
 * All fields are immutable once created
 */
interface CustomBlockCode {
  /**
   * HTML template
   * Must be a single root element
   * No <script> or <style> tags allowed here
   */
  html: string;

  /**
   * CSS styles scoped to this block
   * Automatically prefixed to prevent leakage
   */
  css: string;

  /**
   * JavaScript code
   * Runs in strict mode with no global access
   * Has access to HIVE SDK via window.HIVE
   */
  js: string;

  /**
   * Hash of code bundle for integrity checking
   */
  hash: string;
}

/**
 * Block interface definition
 * Describes what the block can do and what it needs
 */
interface CustomBlockManifest {
  /**
   * Actions this block can handle
   * Maps to element action system
   */
  actions: CustomBlockAction[];

  /**
   * Input ports (data the block consumes)
   */
  inputs: CustomBlockPort[];

  /**
   * Output ports (data the block produces)
   */
  outputs: CustomBlockPort[];

  /**
   * State schema (what the block stores)
   * Uses JSON Schema format
   */
  stateSchema?: {
    type: 'object';
    properties: Record<string, {
      type: 'string' | 'number' | 'boolean' | 'object' | 'array';
      description?: string;
      default?: unknown;
    }>;
  };

  /**
   * Design tokens the block needs
   * Automatically injected as CSS custom properties
   */
  requiredTokens?: {
    colors?: string[];      // e.g., ['primary', 'surface', 'text']
    spacing?: string[];     // e.g., ['sm', 'md', 'lg']
    typography?: string[];  // e.g., ['body', 'heading']
    radius?: string[];      // e.g., ['sm', 'md']
  };
}

/**
 * Action definition for custom block
 */
interface CustomBlockAction {
  /** Action identifier (e.g., 'submit', 'vote') */
  id: string;

  /** Human-readable label */
  label: string;

  /** Action category (determines state update behavior) */
  category: 'aggregate' | 'personal' | 'hybrid';

  /** Expected payload schema (JSON Schema) */
  payloadSchema?: Record<string, unknown>;
}

/**
 * Input/Output port definition
 */
interface CustomBlockPort {
  /** Port identifier */
  id: string;

  /** Human-readable label */
  label: string;

  /** Data type */
  type: 'string' | 'number' | 'boolean' | 'object' | 'array';

  /** Optional description */
  description?: string;
}
```

---

## Version Management

Custom blocks are versioned to support safe iteration and rollback.

### Version Flow

1. **Create:** AI generates initial code → v1 created
2. **Edit:** User edits or AI regenerates → v2 created (v1 immutable)
3. **Deploy:** Version is locked on deployment, can't change after users interact
4. **Rollback:** Can revert to previous version before deployment

### Storage Structure

```
customBlocks/
  {blockId}/
    versions/
      v1/
        code: { html, css, js, hash }
        manifest: { ... }
        createdAt: timestamp
      v2/
        code: { html, css, js, hash }
        manifest: { ... }
        createdAt: timestamp
    current/
      version: 2
      status: 'draft' | 'deployed'
```

---

## Sandbox Architecture

### Iframe Setup

```html
<iframe
  sandbox="allow-scripts"
  csp="default-src 'none'; script-src 'unsafe-inline'; style-src 'unsafe-inline'; img-src data: https:"
  srcdoc="<!DOCTYPE html>
    <html>
      <head>
        <style id='hive-tokens'>/* Injected design tokens */</style>
        <style id='block-styles'>/* Block CSS */</style>
      </head>
      <body>
        <!-- Block HTML -->
        <script src='hive-sdk.js'></script>
        <script>/* Block JS */</script>
      </body>
    </html>"
></iframe>
```

### CSP Policy (Default)

```
default-src 'none';
script-src 'unsafe-inline';
style-src 'unsafe-inline';
img-src data: https: [allowed-domains];
font-src data: https: [allowed-domains];
connect-src 'none';
frame-src 'none';
object-src 'none';
```

**Key restrictions:**
- No `eval()` or `Function()` constructor
- No network requests (no `fetch`, `XMLHttpRequest`, `WebSocket`)
- No `localStorage`, `sessionStorage`, `indexedDB`
- No access to parent DOM or globals
- No plugins, objects, or embeds

---

## HIVE SDK (postMessage Bridge)

### SDK Interface

Custom blocks access HIVE functionality via `window.HIVE`:

```typescript
interface HIVESDK {
  /**
   * Get current state for this block
   */
  getState(): Promise<BlockState>;

  /**
   * Update state
   */
  setState(updates: Partial<BlockState>): Promise<void>;

  /**
   * Execute an action
   */
  executeAction(actionId: string, payload?: unknown): Promise<ActionResult>;

  /**
   * Subscribe to state changes
   */
  onStateChange(callback: (state: BlockState) => void): () => void;

  /**
   * Get input data from connected elements
   */
  getInput(inputId: string): Promise<unknown>;

  /**
   * Emit output data to connected elements
   */
  emitOutput(outputId: string, data: unknown): Promise<void>;

  /**
   * Get current user context
   */
  getContext(): Promise<ToolContext>;

  /**
   * Show a toast notification
   */
  notify(message: string, type?: 'success' | 'error' | 'info'): void;

  /**
   * Log to parent (for debugging)
   */
  log(...args: unknown[]): void;
}
```

### postMessage Protocol

All communication uses structured messages:

```typescript
// Parent → Iframe
type ParentMessage =
  | { type: 'state_update'; state: BlockState }
  | { type: 'input_update'; inputId: string; data: unknown }
  | { type: 'action_result'; requestId: string; result: ActionResult };

// Iframe → Parent
type IframeMessage =
  | { type: 'ready' }
  | { type: 'get_state'; requestId: string }
  | { type: 'set_state'; requestId: string; updates: Partial<BlockState> }
  | { type: 'execute_action'; requestId: string; actionId: string; payload?: unknown }
  | { type: 'emit_output'; outputId: string; data: unknown }
  | { type: 'log'; args: unknown[] };
```

---

## Design Token Injection

HIVE design tokens are automatically injected as CSS custom properties.

### Injected Tokens

```css
:root {
  /* Colors */
  --hive-color-primary: #...;
  --hive-color-surface: #...;
  --hive-color-text: #...;
  --hive-color-error: #...;

  /* Spacing */
  --hive-spacing-sm: 8px;
  --hive-spacing-md: 16px;
  --hive-spacing-lg: 24px;

  /* Typography */
  --hive-font-body: ...;
  --hive-font-heading: ...;
  --hive-text-sm: 14px;
  --hive-text-md: 16px;
  --hive-text-lg: 18px;

  /* Border radius */
  --hive-radius-sm: 4px;
  --hive-radius-md: 8px;
  --hive-radius-lg: 12px;

  /* Motion */
  --hive-transition-fast: 150ms;
  --hive-transition-normal: 300ms;
}
```

### Usage in Custom Blocks

```css
.my-button {
  background: var(--hive-color-primary);
  padding: var(--hive-spacing-md);
  border-radius: var(--hive-radius-md);
  transition: all var(--hive-transition-fast);
}
```

---

## AI Generation Integration

### Hybrid Compositions

AI can now generate tools with both native elements and custom blocks:

```json
{
  "elements": [
    {
      "elementId": "search-input",
      "instanceId": "elem_001",
      "config": { "placeholder": "Search..." }
    },
    {
      "elementId": "custom-block",
      "instanceId": "elem_002",
      "config": {
        "blockId": "block_xyz",
        "version": 1,
        "code": {
          "html": "<div class='card'>...</div>",
          "css": ".card { ... }",
          "js": "window.HIVE.onStateChange(...);"
        },
        "manifest": {
          "actions": [{ "id": "vote", "category": "aggregate" }],
          "inputs": [{ "id": "query", "type": "string" }],
          "outputs": [{ "id": "results", "type": "array" }]
        }
      }
    }
  ],
  "connections": [
    {
      "from": { "instanceId": "elem_001", "output": "query" },
      "to": { "instanceId": "elem_002", "input": "query" }
    }
  ]
}
```

### When to Use Custom Blocks

AI should prefer native elements when possible. Use custom blocks for:
- **Unique UI patterns** not covered by native elements
- **Complex visualizations** (custom charts, data viz)
- **Specialized interactions** (drag-drop builders, canvas drawing)
- **Custom animations** or motion design
- **Branded components** (school colors, mascots, custom styling)

### Prompt Updates

System prompt additions:

```
You now have access to custom blocks for unlimited UI flexibility.

NATIVE ELEMENTS (preferred):
- Use these whenever possible for consistency and performance
- 27 built-in elements covering common patterns
- Fully tested, accessible, optimized

CUSTOM BLOCKS (use sparingly):
- For UI patterns not covered by native elements
- Generates HTML/CSS/JS in sandboxed iframe
- Must define manifest (actions, inputs, outputs, state schema)
- Design tokens auto-injected for consistency
- Use HIVE SDK for state and communication

Example custom block:
{
  "elementId": "custom-block",
  "config": {
    "metadata": { "name": "Bingo Card", "description": "Interactive bingo card" },
    "code": {
      "html": "<div class='bingo-grid'>...</div>",
      "css": ".bingo-grid { display: grid; ... }",
      "js": "const cells = [...]; window.HIVE.setState({ marked: cells });"
    },
    "manifest": {
      "actions": [{ "id": "mark_cell", "category": "personal" }],
      "stateSchema": {
        "type": "object",
        "properties": {
          "marked": { "type": "array", "default": [] }
        }
      }
    }
  }
}
```

---

## Validation

Custom blocks are validated at multiple stages:

### 1. Schema Validation (Zod)
- Config structure matches `CustomBlockConfigSchema`
- Required fields present
- Types correct

### 2. Code Validation
- HTML parses without errors
- CSS valid
- JS syntax valid (parsed but not executed)
- No forbidden patterns (eval, inline event handlers)

### 3. Manifest Validation
- Actions have valid categories
- Ports have valid types
- State schema is valid JSON Schema

### 4. Security Validation
- No `<script>` tags in HTML
- No inline event handlers (`onclick`, etc.)
- No data URIs in JS
- CSP allowlist validated

### 5. Size Limits
- HTML: max 50KB
- CSS: max 25KB
- JS: max 50KB
- Total bundle: max 100KB

---

## Firestore Schema

### Tool Composition Document

```typescript
// deployedTools/{deploymentId}
{
  composition: {
    elements: [
      {
        elementId: 'custom-block',
        instanceId: 'elem_001',
        config: {
          blockId: 'block_abc',
          version: 1,
          metadata: { ... },
          code: { html, css, js, hash },
          manifest: { actions, inputs, outputs, stateSchema }
        },
        position: { x: 0, y: 0 },
        size: { width: 400, height: 300 }
      }
    ]
  }
}
```

### Version History (Optional Future Enhancement)

```typescript
// customBlocks/{blockId}/versions/{versionNumber}
{
  version: 1,
  code: { html, css, js, hash },
  manifest: { ... },
  createdAt: timestamp,
  createdBy: userId,
  status: 'draft' | 'deployed',
  deploymentCount: 0
}
```

---

## Security Considerations

### Threat Model

**Threats mitigated:**
- ✅ XSS attacks via malicious scripts
- ✅ Data exfiltration via network requests
- ✅ Parent DOM manipulation
- ✅ Cookie/localStorage theft
- ✅ Clickjacking
- ✅ Resource exhaustion

**Threats NOT mitigated:**
- ⚠️ UI spoofing within iframe (user sees custom UI as legitimate)
- ⚠️ Denial of service via infinite loops (requires timeout mechanism)
- ⚠️ Phishing via convincing fake forms (requires user education)

### Additional Protections

1. **Code review** for AI-generated blocks before deployment
2. **User reporting** for suspicious custom blocks
3. **Execution timeout** (5 second limit for JS execution)
4. **Memory limits** (iframe killed if exceeds 50MB)
5. **Rate limiting** on postMessage (max 100 msg/sec)

---

## Performance Considerations

### Optimization Strategies

1. **Lazy loading** — Only load iframes for visible custom blocks
2. **Code caching** — Cache code bundles by hash
3. **Precompilation** — Validate and prepare code on save, not on render
4. **Resource hints** — Preconnect to allowed CSP domains
5. **Virtualization** — Unload offscreen iframes after 30s

### Bundle Size Limits

- HTML: 50KB max
- CSS: 25KB max
- JS: 50KB max
- Total: 100KB max

Above limits, warn creator and suggest optimization.

---

## Migration Path

Custom blocks are additive — no migration needed for existing tools.

### Rollout Plan

1. **Phase 5.1** — Schema design ✅ (this document)
2. **Phase 5.2** — Iframe renderer + postMessage bridge
3. **Phase 5.3** — HIVE SDK implementation
4. **Phase 5.4** — CSP policy + security validation
5. **Phase 5.5** — Design token injection
6. **Phase 5.6** — AI generation updates
7. **Phase 5.7** — Testing + dogfooding
8. **Phase 5.8** — Beta launch to select spaces
9. **Phase 5.9** — Full rollout

---

## Example Use Cases

1. **Custom Bingo Card** — 5x5 grid with tap-to-mark interaction
2. **Bracket Generator** — Tournament bracket with drag-to-fill
3. **Color Wheel Picker** — Custom color selection UI
4. **Campus Map** — Interactive building directory
5. **Recipe Card** — Ingredient checklist with step-by-step cooking timer
6. **Habit Tracker** — Monthly calendar with streak visualization
7. **Seating Chart** — Drag-and-drop room layout builder
8. **Pitch Deck** — Swipeable slides with animations

---

## Open Questions

1. **Should custom blocks be shareable?**
   → Future: Block marketplace where users can publish/reuse blocks

2. **Should we support React/Vue components?**
   → Future: Compile framework components to vanilla JS bundle

3. **Should we sandbox CSS more strictly?**
   → Current: CSS is scoped to iframe, can't escape. Sufficient for v1.

4. **How do we handle breaking changes in HIVE SDK?**
   → Version SDK in postMessage protocol, support multiple versions

5. **Should we limit custom blocks per tool?**
   → Recommend max 3-5 custom blocks per tool for performance

---

## Success Metrics

- **Adoption:** % of tools using custom blocks (target: 15% after 6 months)
- **Security:** Zero XSS incidents from custom blocks
- **Performance:** <100ms iframe load time, <50ms postMessage latency
- **Quality:** <5% of custom blocks reported for issues
- **Reusability:** 20% of custom blocks reused across multiple tools

---

## References

- [MDN: iframe sandbox](https://developer.mozilla.org/en-US/docs/Web/HTML/Element/iframe#attr-sandbox)
- [CSP Policy Guide](https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP)
- [postMessage API](https://developer.mozilla.org/en-US/docs/Web/API/Window/postMessage)
- [JSON Schema](https://json-schema.org/)
- HIVE Design System: `packages/tokens/`
