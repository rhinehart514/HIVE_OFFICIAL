rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function isAdmin() {
      return isAuthenticated() && 
        exists(/databases/$(database)/documents/admins/$(request.auth.uid));
    }

    // Campus isolation helpers
    // Campus ID is derived from the user's custom claims or defaults to ub-buffalo for vBETA
    // To enable multi-campus:
    // 1. Set custom claim on Firebase Auth token: { campusId: 'campus-slug' }
    // 2. Done during onboarding via admin SDK: admin.auth().setCustomUserClaims(uid, { campusId })
    function getUserCampusId() {
      // Try custom claim first, fallback to ub-buffalo for backwards compatibility
      return request.auth.token.campusId != null
        ? request.auth.token.campusId
        : 'ub-buffalo';
    }

    // Optimized campus check - uses auth token claim (no extra get() calls)
    function sameCampus() {
      return resource.data.campusId == getUserCampusId();
    }

    function sameCampusWrite() {
      return request.resource.data.campusId == getUserCampusId();
    }

    // SECURITY: Check if user is a member of a space (for board/message access)
    // Uses flat spaceMembers collection with composite key format: {spaceId}_{userId}
    // NOTE: New memberships (join-v2) use this format. Legacy docs require API-side validation.
    // This provides defense-in-depth - API also validates, but Firestore rules catch direct SDK access.
    function isSpaceMember(spaceId) {
      return isAuthenticated() && exists(/databases/$(database)/documents/spaceMembers/$(spaceId + '_' + request.auth.uid));
    }

    // SECURITY: Check if user is a space leader (owner, admin, or moderator)
    // Checks spaceMembers doc for elevated roles using composite key
    function isSpaceLeader(spaceId) {
      let memberDoc = get(/databases/$(database)/documents/spaceMembers/$(spaceId + '_' + request.auth.uid));
      return memberDoc != null &&
             memberDoc.data.isActive == true &&
             (memberDoc.data.role == 'owner' ||
              memberDoc.data.role == 'admin' ||
              memberDoc.data.role == 'moderator');
    }

    // SECURITY: Ensure campusId is never changed after document creation
    // CampusId immutability is a critical invariant - see docs/architecture/FIRESTORE_SCHEMA.md
    function campusIdUnchanged() {
      return !request.resource.data.diff(resource.data).affectedKeys().hasAny(['campusId']);
    }
    
    // User documents - users can read/write their own data
    match /users/{userId} {
      allow read, write: if isOwner(userId);
      allow read: if isAuthenticated(); // Allow other users to read basic profile info
    }
    
    // Admin collection - only admins can access
    match /admins/{adminId} {
      allow read, write: if isAdmin();
    }
    
    // Flat spaceMembers collection - Optimized membership tracking
    match /spaceMembers/{memberId} {
      // Users can read their own memberships + admins can read all
      allow read: if isAuthenticated() && sameCampus() && (
        isOwner(resource.data.userId) ||
        isAdmin()
      );
      // Users can create their own memberships (join spaces)
      allow create: if isAuthenticated() && sameCampusWrite() && isOwner(request.resource.data.userId);
      // Users can update their own memberships (leave, etc.)
      allow update: if isAuthenticated() && sameCampusWrite() && (
        isOwner(resource.data.userId) ||
        isAdmin()
      );
      // Only admins can delete
      allow delete: if isAuthenticated() && isAdmin();
    }

    // Spaces collection - flat structure
    // IMPORTANT: Fine-grained member role permissions (owner/admin/moderator) are enforced
    // server-side via the SpaceManagementService DDD layer. Firebase rules provide:
    // 1. Campus isolation (users can only access their campus's spaces)
    // 2. Basic authentication checks
    // 3. Creator permissions for fallback
    // Members are stored in spaceMembers collection with auto-generated IDs.
    match /spaces/{spaceId} {
      // Enforce campus isolation on reads
      allow read: if isAuthenticated() && sameCampus();

      // Create: authenticated users within campus can create spaces
      // Server-side validates builder permissions via check-create-permission API
      allow create: if isAuthenticated() && sameCampusWrite();

      // Update: Space leaders (owner/admin/moderator) can update spaces
      // Platform admins and original creators always have access as fallback
      // SECURITY: campusId must never change after creation
      allow update: if isAuthenticated() && sameCampusWrite() && campusIdUnchanged() && (
        isSpaceLeader(spaceId) ||
        isAdmin() ||
        resource.data.createdBy == request.auth.uid
      );

      // Delete: Only platform admins or original creator can delete spaces
      allow delete: if isAuthenticated() && (
        isAdmin() ||
        resource.data.createdBy == request.auth.uid
      );

      // Space members - DEPRECATED: Use flat spaceMembers collection instead
      match /members/{memberId} {
        allow read: if isAuthenticated() && sameCampus();
        allow write: if isAuthenticated() && sameCampusWrite() && (
          isOwner(memberId) ||
          isAdmin()
        );
      }

      // Space chat boards (channels)
      // SECURITY: Board access requires space membership
      match /boards/{boardId} {
        // Members can read boards (or public space viewers)
        allow read: if isAuthenticated() && sameCampus() && (
          isSpaceMember(spaceId) ||
          isAdmin() ||
          // Allow public space reads (space doc check)
          get(/databases/$(database)/documents/spaces/$(spaceId)).data.visibility == 'public'
        );
        // SECURITY: Only space leaders can create/update boards
        allow create, update: if isAuthenticated() && sameCampusWrite() && (
          isSpaceLeader(spaceId) ||
          isAdmin()
        );
        // Only admins can delete boards
        allow delete: if isAuthenticated() && isAdmin();

        // Board messages
        // SECURITY: Message access requires space membership
        match /messages/{messageId} {
          // Members can read messages (or public space viewers)
          allow read: if isAuthenticated() && sameCampus() && (
            isSpaceMember(spaceId) ||
            isAdmin() ||
            get(/databases/$(database)/documents/spaces/$(spaceId)).data.visibility == 'public'
          );
          // SECURITY: Only space members can create messages
          allow create: if isAuthenticated() && sameCampusWrite() && (
            isSpaceMember(spaceId) ||
            isAdmin()
          );
          // Users can update/delete their own messages, or leaders can moderate
          allow update, delete: if isAuthenticated() && sameCampusWrite() && (
            isOwner(resource.data.authorId) ||
            isSpaceLeader(spaceId) ||
            isAdmin()
          );
        }

        // Board typing indicators (ephemeral, 5-second TTL)
        // SECURITY: Only members can see/set typing indicators
        match /typing/{odId} {
          allow read: if isAuthenticated() && sameCampus() && isSpaceMember(spaceId);
          allow write: if isAuthenticated() && sameCampusWrite() && isSpaceMember(spaceId);
        }
      }

      // Space tabs (custom navigation)
      // SECURITY: Only space leaders can configure tabs
      match /tabs/{tabId} {
        allow read: if isAuthenticated() && sameCampus();
        allow create, update: if isAuthenticated() && sameCampusWrite() && (
          isSpaceLeader(spaceId) ||
          isAdmin()
        );
        allow delete: if isAuthenticated() && (
          isSpaceLeader(spaceId) ||
          isAdmin()
        );
      }

      // Space widgets (sidebar components)
      // SECURITY: Only space leaders can configure widgets
      match /widgets/{widgetId} {
        allow read: if isAuthenticated() && sameCampus();
        allow create, update: if isAuthenticated() && sameCampusWrite() && (
          isSpaceLeader(spaceId) ||
          isAdmin()
        );
        allow delete: if isAuthenticated() && (
          isSpaceLeader(spaceId) ||
          isAdmin()
        );
      }

      // HiveLab tools placed in this space
      // SECURITY: Only space leaders can place/configure tools
      match /placed_tools/{placementId} {
        allow read: if isAuthenticated() && sameCampus();
        allow create, update: if isAuthenticated() && sameCampusWrite() && (
          isSpaceLeader(spaceId) ||
          isAdmin()
        );
        allow delete: if isAuthenticated() && (
          isSpaceLeader(spaceId) ||
          isAdmin()
        );

        // Per-user state for placed tools
        match /state/{odId} {
          allow read: if isAuthenticated() && sameCampus();
          allow write: if isAuthenticated() && sameCampusWrite();
        }

        // User responses/submissions
        match /responses/{odId} {
          allow read: if isAuthenticated() && sameCampus();
          allow write: if isAuthenticated() && sameCampusWrite();
        }
      }

      // Space activity log
      match /activity/{activityId} {
        allow read: if isAuthenticated() && sameCampus();
        allow create: if isAuthenticated() && sameCampusWrite();
      }

      // Inline components (polls, countdowns, RSVPs in chat)
      // SECURITY: Component access follows space membership rules
      match /inlineComponents/{componentId} {
        // Members can read components
        allow read: if isAuthenticated() && sameCampus() && (
          isSpaceMember(spaceId) ||
          isAdmin() ||
          get(/databases/$(database)/documents/spaces/$(spaceId)).data.visibility == 'public'
        );
        // Members can create components (via chat)
        allow create: if isAuthenticated() && sameCampusWrite() && (
          isSpaceMember(spaceId) ||
          isAdmin()
        );
        // Component creators and leaders can update (e.g., close poll)
        allow update: if isAuthenticated() && sameCampusWrite() && (
          isOwner(resource.data.createdBy) ||
          isSpaceLeader(spaceId) ||
          isAdmin()
        );
        // Only leaders/admins can delete
        allow delete: if isAuthenticated() && (
          isSpaceLeader(spaceId) ||
          isAdmin()
        );

        // Component participations (votes, RSVPs)
        match /participations/{odId} {
          // Members can read all participations (for showing results)
          allow read: if isAuthenticated() && sameCampus() && isSpaceMember(spaceId);
          // Members can create their own participation
          allow create: if isAuthenticated() && sameCampusWrite() &&
            isSpaceMember(spaceId) &&
            request.resource.data.userId == request.auth.uid;
          // Users can update their own participation (change vote/RSVP)
          allow update: if isAuthenticated() && sameCampusWrite() &&
            isOwner(resource.data.userId);
          // Users can delete their own participation
          allow delete: if isAuthenticated() &&
            isOwner(resource.data.userId);
        }
      }
    }
    
    // Builder requests - users can create and read their own
    // SECURITY: Campus-isolated to prevent cross-campus access
    match /builderRequests/{requestId} {
      allow read: if isAuthenticated() && sameCampus() && (
        isOwner(resource.data.userId) ||
        isAdmin()
      );
      allow create: if isAuthenticated() && sameCampusWrite() && isOwner(request.resource.data.userId);
      allow update: if isAuthenticated() && sameCampusWrite() && isAdmin(); // Only admins can approve/reject
    }
    
    // Feature flags - read only for authenticated users, write for admins only
    match /featureFlags/{flagId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // Feature flag analytics - admin only
    match /featureFlagAnalytics/{analyticsId} {
      allow read, write: if isAdmin();
    }
    
    // Real-time messages - SSE service (deprecated but kept for backwards compat)
    // SECURITY: Campus-isolated
    match /realtimeMessages/{messageId} {
      allow read: if isAuthenticated() && (
        // No campusId on legacy messages - check target users
        resource.data.senderId == request.auth.uid ||
        resource.data.targetUsers == null ||
        request.auth.uid in resource.data.targetUsers
      );
      allow write: if isAuthenticated(); // Server handles validation and campusId
    }
    
    // Presence data
    // SECURITY: Campus-isolated to prevent cross-campus presence visibility
    match /presence/{userId} {
      allow read: if isAuthenticated() && sameCampus();
      allow write: if isOwner(userId);
    }
    
    // Schools - authenticated read access, admin-only write
    // SECURITY: Require authentication to prevent enumeration attacks
    match /schools/{schoolId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    // Profiles - Extended user data (campus-isolated with privacy controls)
    // SECURITY: Campus isolation prevents cross-campus profile enumeration
    match /profiles/{profileId} {
      // Users in same campus can read profiles (privacy enforced at query level)
      allow read: if isAuthenticated() && sameCampus();
      // Users can write their own profile
      allow write: if isOwner(profileId);
    }

    // Handles - Username lookup table
    // SECURITY: Campus isolation for handle lookups
    match /handles/{handle} {
      // Users in same campus can read handle lookups
      allow read: if isAuthenticated() && sameCampus();
      // Only the owner can claim/update their handle
      allow write: if isAuthenticated() && sameCampusWrite() &&
        request.resource.data.userId == request.auth.uid;
    }

    // Connections - User-to-user social connections
    match /connections/{connectionId} {
      // Users can read connections they're part of
      allow read: if isAuthenticated() && sameCampus() && (
        resource.data.fromUserId == request.auth.uid ||
        resource.data.toUserId == request.auth.uid ||
        isAdmin()
      );
      // Users can create connection requests
      allow create: if isAuthenticated() && sameCampusWrite() &&
        request.resource.data.fromUserId == request.auth.uid;
      // Users can update connections they're part of (accept/reject)
      allow update: if isAuthenticated() && sameCampusWrite() && (
        resource.data.fromUserId == request.auth.uid ||
        resource.data.toUserId == request.auth.uid
      );
      // Users can delete their own connections
      allow delete: if isAuthenticated() && (
        resource.data.fromUserId == request.auth.uid ||
        resource.data.toUserId == request.auth.uid
      );
    }

    // Notifications - User notifications
    match /notifications/{notificationId} {
      // Users can read their own notifications
      allow read: if isAuthenticated() && isOwner(resource.data.userId);
      // System creates notifications (server-side)
      allow create: if isAuthenticated();
      // Users can update (mark read) their own notifications
      allow update: if isAuthenticated() && isOwner(resource.data.userId);
      // Users can delete their own notifications
      allow delete: if isAuthenticated() && isOwner(resource.data.userId);
    }

    // DEPRECATED: Flat posts collection - Legacy feed data
    // HIVE uses chat-first architecture. New content goes through space chat boards.
    // This collection is kept for historical feed data only.
    match /posts/{postId} {
      // Campus-isolated reads
      allow read: if isAuthenticated() && sameCampus();
      // Authenticated users can create posts (server validates membership)
      allow create: if isAuthenticated() && sameCampusWrite();
      // Authors can update/delete their own posts
      allow update, delete: if isAuthenticated() && sameCampusWrite() && (
        isOwner(resource.data.authorId) ||
        isAdmin()
      );

      // Post comments
      match /comments/{commentId} {
        allow read: if isAuthenticated() && sameCampus();
        allow create: if isAuthenticated() && sameCampusWrite();
        allow update, delete: if isAuthenticated() && sameCampusWrite() && (
          isOwner(resource.data.authorId) ||
          isAdmin()
        );
      }
    }

    // Flat events collection - For cross-space calendar queries
    match /events/{eventId} {
      // Campus-isolated reads
      allow read: if isAuthenticated() && sameCampus();
      // Authenticated users can create events (server validates permissions)
      allow create: if isAuthenticated() && sameCampusWrite();
      // Event creators and admins can update/delete
      allow update, delete: if isAuthenticated() && sameCampusWrite() && (
        isOwner(resource.data.createdBy) ||
        isAdmin()
      );
    }

    // RSVPs - Event attendance tracking
    match /rsvps/{rsvpId} {
      // Users can read RSVPs for events they can access
      allow read: if isAuthenticated() && sameCampus();
      // Users can create their own RSVPs
      allow create: if isAuthenticated() && sameCampusWrite() &&
        isOwner(request.resource.data.userId);
      // Users can update/delete their own RSVPs
      allow update, delete: if isAuthenticated() && sameCampusWrite() &&
        isOwner(resource.data.userId);
    }

    // Deployed tools - Global tool deployment registry
    match /deployedTools/{deploymentId} {
      // Campus-isolated reads
      allow read: if isAuthenticated() && sameCampus();
      // Authenticated users can deploy tools (server validates permissions)
      allow create: if isAuthenticated() && sameCampusWrite();
      // Deployers can update/remove their deployments
      allow update, delete: if isAuthenticated() && sameCampusWrite() && (
        isOwner(resource.data.deployedBy) ||
        isAdmin()
      );
    }

    // Tool states - Runtime state for deployed tools
    match /toolStates/{stateId} {
      // Users can read tool states they have access to
      allow read: if isAuthenticated() && sameCampus();
      // Authenticated users can write state (server validates)
      allow write: if isAuthenticated() && sameCampusWrite();
    }

    // Activity events - Platform-wide activity log
    match /activityEvents/{eventId} {
      // Campus-isolated reads
      allow read: if isAuthenticated() && sameCampus();
      // System creates activity events
      allow create: if isAuthenticated() && sameCampusWrite();
      // No updates or deletes (activity log is append-only)
      allow update, delete: if false;
    }

    // Content reports - User-submitted reports
    match /contentReports/{reportId} {
      // Users can read their own reports + admins can read all
      allow read: if isAuthenticated() && (
        isOwner(resource.data.reporterId) ||
        isAdmin()
      );
      // Users can create reports
      allow create: if isAuthenticated() && isOwner(request.resource.data.reporterId);
      // Only admins can update reports (for resolution)
      allow update: if isAdmin();
      // Only admins can delete reports
      allow delete: if isAdmin();
    }

    // Tools
    match /tools/{toolId} {
      allow read: if isAuthenticated() && sameCampus();
      allow write: if isAuthenticated() && sameCampusWrite() && (
        isOwner(resource.data.createdBy) ||
        isAdmin()
      );

      // Tool versions
      match /versions/{versionId} {
        allow read: if isAuthenticated() && sameCampus();
        allow write: if isAuthenticated() && sameCampusWrite() && (
          isOwner(get(/databases/$(database)/documents/tools/$(toolId)).data.createdBy) ||
          isAdmin()
        );
      }
    }

    // Chat channels - Legacy flat structure for DM/group chats
    match /chatChannels/{channelId} {
      // Participants can read their channels
      allow read: if isAuthenticated() && (
        request.auth.uid in resource.data.participants ||
        isAdmin()
      );
      // Authenticated users can create channels
      allow create: if isAuthenticated() &&
        request.auth.uid in request.resource.data.participants;
      // Participants can update their channels
      allow update: if isAuthenticated() && (
        request.auth.uid in resource.data.participants ||
        isAdmin()
      );
      // Only admins can delete channels
      allow delete: if isAdmin();
    }

    // Typing indicators - Ephemeral, auto-expires
    // SECURITY: Campus-isolated to prevent cross-campus visibility
    match /typingIndicators/{indicatorId} {
      // Campus-isolated reads for real-time updates
      allow read: if isAuthenticated() && sameCampus();
      // Users can create/update their own typing indicators
      allow create, update: if isAuthenticated() && sameCampusWrite() &&
        request.resource.data.userId == request.auth.uid;
      // Users can delete their own typing indicators
      allow delete: if isAuthenticated() &&
        resource.data.userId == request.auth.uid;
    }

    // Rituals V2.0 - Configuration-driven behavioral campaigns
    match /rituals/{ritualId} {
      // All authenticated campus users can read active rituals
      allow read: if isAuthenticated() && sameCampus();
      // Only admins can create/update ritual configs
      allow create: if isAuthenticated() && isAdmin() && sameCampusWrite();
      allow update: if isAuthenticated() && isAdmin() && sameCampusWrite();
      allow delete: if isAuthenticated() && isAdmin();
    }

    // Ritual participation tracking
    match /ritual_participation/{partId} {
      // Users can read their own participation + admins can read all
      allow read: if isAuthenticated() && sameCampus() && (isOwner(resource.data.userId) || isAdmin());
      // Users can join rituals (create participation record)
      allow create: if isAuthenticated() && sameCampusWrite() && isOwner(request.resource.data.userId);
      // Users can update their own participation
      allow update: if isAuthenticated() && sameCampusWrite() && isOwner(resource.data.userId);
      // Only admins can delete participation
      allow delete: if isAuthenticated() && isAdmin();
    }

    // Ritual participants (leaderboard data)
    match /ritual_participants/{participantId} {
      // Campus-isolated reads for leaderboards
      allow read: if isAuthenticated() && sameCampus();
      // Only system/admin can write participant scores
      allow write: if isAuthenticated() && isAdmin();
    }

    // Ritual events (phase transitions, milestones)
    match /ritual_events/{eventId} {
      // Campus-isolated reads for event logs (all campus users can read their campus events)
      allow read: if isAuthenticated() && sameCampus();
      // Only system/admin can create events
      allow create: if isAuthenticated() && isAdmin();
    }

    // Ritual templates (admin composer library)
    match /ritual_templates/{templateId} {
      // All authenticated users can browse templates
      allow read: if isAuthenticated();
      // Only admins can create/update templates
      allow write: if isAuthenticated() && isAdmin();
    }

    // Ritual votes (Tournament archetype)
    match /ritual_votes/{voteId} {
      // Users can read votes in their campus rituals
      allow read: if isAuthenticated() && sameCampus();
      // Users can create votes (one per matchup per user)
      allow create: if isAuthenticated() && sameCampusWrite() && isOwner(request.resource.data.userId);
      // No updates or deletes (votes are immutable)
      allow update, delete: if false;
    }

    // Ritual matchups (Tournament archetype)
    match /ritual_matchups/{matchupId} {
      // Users can read matchups in their campus rituals
      allow read: if isAuthenticated() && sameCampus();
      // Only admins can create/update matchups
      allow write: if isAuthenticated() && isAdmin();
    }

    // Ritual usage (Feature Drop archetype)
    match /ritual_usage/{usageId} {
      // Users can read their own usage + admins can read all
      allow read: if isAuthenticated() && sameCampus() && (isOwner(resource.data.userId) || isAdmin());
      // System tracks usage automatically
      allow create: if isAuthenticated() && sameCampusWrite() && isOwner(request.resource.data.userId);
      allow update: if isAuthenticated() && sameCampusWrite() && isOwner(resource.data.userId);
    }

    // Ritual feedback (post-ritual surveys)
    match /ritual_feedback/{feedbackId} {
      // Users can read their own feedback + admins can read all
      allow read: if isAuthenticated() && sameCampus() && (isOwner(resource.data.userId) || isAdmin());
      // Users can submit feedback
      allow create: if isAuthenticated() && sameCampusWrite() && isOwner(request.resource.data.userId);
      // No updates or deletes (feedback is immutable)
      allow update, delete: if false;
    }

    // Anonymous content accountability (Leak archetype)
    match /anonymous_content_accountability/{accountabilityId} {
      // Only admins can read (for moderation)
      allow read: if isAuthenticated() && isAdmin();
      // System creates accountability records
      allow create: if isAuthenticated() && sameCampusWrite();
      // No updates or public deletes
      allow update, delete: if false;
    }
    
    // AI generation records (HiveLab quality tracking)
    // Server-only write access - client reads for their own generations
    match /ai_generations/{generationId} {
      // Users can read their own generation records
      allow read: if isAuthenticated() && (
        isOwner(resource.data.userId) ||
        isAdmin()
      );
      // Server-only writes (admin SDK bypasses rules)
      allow write: if false;
    }

    // Analytics events (tool usage tracking)
    match /analytics_events/{eventId} {
      // Admins can read analytics
      allow read: if isAdmin();
      // Server-only writes
      allow write: if false;
    }

    // Test collection - for diagnostics
    match /test/{testId} {
      allow read, write: if isAuthenticated();
    }

    // Verification codes - SERVER ONLY (Admin SDK only)
    // Used by /api/auth/send-code and /api/auth/verify-code
    // Contains hashed codes, expiry times, and attempt counts
    // SECURITY: No client access - all verification happens server-side
    match /verification_codes/{codeId} {
      allow read, write: if false;
    }

    // Verification lockouts - SERVER ONLY (Admin SDK only)
    // Tracks email lockouts after too many failed verification attempts
    // SECURITY: No client access - prevents lockout bypass attempts
    match /verification_lockouts/{email} {
      allow read, write: if false;
    }

    // Default deny all other access
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
